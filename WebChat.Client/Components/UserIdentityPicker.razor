@inherits StoreSubscriberComponent
@inject UserIdentityStore Store
@inject IDispatcher Dispatcher

<div class="user-identity-picker @(_dropdownOpen ? "open" : "")">
    <button class="avatar-button" @onclick="ToggleDropdown" @onclick:stopPropagation="true" title="@(_selectedUser?.Id ?? "Select user")">
        @if (_selectedUser is not null)
        {
            <img src="@_selectedUser.AvatarUrl" alt="@_selectedUser.Id" class="avatar-image" />
        }
        else
        {
            <div class="avatar-placeholder">?</div>
        }
    </button>

    @if (_dropdownOpen)
    {
        <div class="dropdown-backdrop" @onclick="CloseDropdown"></div>
        <div class="user-dropdown-menu">
            @foreach (var user in _availableUsers)
            {
                <div class="user-dropdown-item @(user.Id == _selectedUser?.Id ? "selected" : "")"
                     @onclick="() => SelectUser(user)">
                    <img src="@user.AvatarUrl" alt="@user.Id" class="user-avatar-small" />
                    <span>@user.Id</span>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool _dropdownOpen;
    private UserConfig? _selectedUser;
    private IReadOnlyList<UserConfig> _availableUsers = [];

    protected override void OnInitialized()
    {
        Subscribe(
            Store.StateObservable,
            state => (state.SelectedUserId, state.AvailableUsers),
            tuple =>
            {
                var (selectedId, users) = tuple;
                _availableUsers = users;
                _selectedUser = users.FirstOrDefault(u => u.Id == selectedId);
            });
    }

    private void ToggleDropdown()
    {
        _dropdownOpen = !_dropdownOpen;
    }

    private void CloseDropdown()
    {
        _dropdownOpen = false;
    }

    private void SelectUser(UserConfig user)
    {
        _dropdownOpen = false;
        if (user.Id != _selectedUser?.Id)
        {
            Dispatcher.Dispatch(new SelectUser(user.Id));
        }
    }
}
