@inject IJSRuntime Js

@code {
    [Parameter] public EventCallback<string> OnSend { get; set; }

    [Parameter] public EventCallback OnCancel { get; set; }

    [Parameter] public bool IsStreaming { get; set; }

    [Parameter] public bool Disabled { get; set; }

    private string _inputText = "";
    private ElementReference _textareaRef;

    // Change tracking
    private bool _lastIsStreaming;
    private bool _lastDisabled;
    private bool _shouldRender = true;

    protected override bool ShouldRender()
    {
        if (!_shouldRender)
        {
            return false;
        }

        _shouldRender = false;
        return true;
    }

    protected override void OnParametersSet()
    {
        if (IsStreaming == _lastIsStreaming && Disabled == _lastDisabled)
        {
            return;
        }

        _lastIsStreaming = IsStreaming;
        _lastDisabled = Disabled;
        _shouldRender = true;
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_inputText) || Disabled)
        {
            return;
        }

        var message = _inputText;
        _inputText = "";

        // Reset textarea height after clearing text
        await Js.InvokeVoidAsync("chatInput.reset", _textareaRef);

        await OnSend.InvokeAsync(message);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e is { Key: "Enter", ShiftKey: false })
        {
            await HandleSubmit();
        }
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }

}

<div class="input-container">
    <div class="input-wrapper">
        <textarea @ref="_textareaRef"
                  class="chat-input"
                  placeholder="Type your message..."
                  @bind="_inputText"
                  @bind:event="oninput"
                  @onkeydown="HandleKeyDown"
                  disabled="@Disabled"
                  rows="1"></textarea>
    </div>

    @if (IsStreaming)
    {
        <button class="btn btn-secondary" @onclick="HandleCancel">
            Cancel
        </button>
    }
    <button class="btn btn-primary"
            @onclick="HandleSubmit"
            disabled="@(Disabled || string.IsNullOrWhiteSpace(_inputText))">
        Send
    </button>
</div>
