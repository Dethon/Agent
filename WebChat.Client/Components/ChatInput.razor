@using WebChat.Client.State
@using WebChat.Client.State.Topics
@using WebChat.Client.State.Streaming
@inherits StoreSubscriberComponent

@inject IJSRuntime Js
@inject IDispatcher Dispatcher
@inject TopicsStore TopicsStore
@inject StreamingStore StreamingStore

@code {
    private string _inputText = "";
    private ElementReference _textareaRef;
    private string? _topicId;
    private string? _selectedAgentId;
    private bool _isStreaming;
    private bool _disabled;

    protected override void OnInitialized()
    {
        Subscribe(TopicsStore.StateObservable, state => (state.SelectedTopicId, state.SelectedAgentId), tuple =>
        {
            _topicId = tuple.SelectedTopicId;
            _selectedAgentId = tuple.SelectedAgentId;
            UpdateDisabledState();
        });

        Subscribe(StreamingStore.StateObservable, state => state.StreamingTopics, streamingTopics =>
        {
            _isStreaming = _topicId is not null && streamingTopics.Contains(_topicId);
        });
    }

    private void UpdateDisabledState()
    {
        _disabled = string.IsNullOrEmpty(_selectedAgentId);
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_inputText) || _disabled)
        {
            return;
        }

        var message = _inputText;
        _inputText = "";

        // Reset textarea height after clearing text
        await Js.InvokeVoidAsync("chatInput.reset", _textareaRef);

        Dispatcher.Dispatch(new SendMessage(_topicId, message));
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e is { Key: "Enter", ShiftKey: false })
        {
            await HandleSubmit();
        }
    }

    private void HandleCancel()
    {
        if (_topicId is not null)
        {
            Dispatcher.Dispatch(new CancelStreaming(_topicId));
        }
    }
}

<div class="input-container">
    <div class="input-wrapper">
        <textarea @ref="_textareaRef"
                  class="chat-input"
                  placeholder="Type your message..."
                  @bind="_inputText"
                  @bind:event="oninput"
                  @onkeydown="HandleKeyDown"
                  disabled="@_disabled"
                  rows="1"></textarea>
    </div>

    @if (_isStreaming)
    {
        <button class="btn btn-secondary" @onclick="HandleCancel">
            Cancel
        </button>
    }
    <button class="btn btn-primary"
            @onclick="HandleSubmit"
            disabled="@(_disabled || string.IsNullOrWhiteSpace(_inputText))">
        Send
    </button>
</div>
