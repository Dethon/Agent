@inherits StoreSubscriberComponent
@inject RenderCoordinator RenderCoordinator

@code {
    [Parameter, EditorRequired] public string TopicId { get; set; } = "";
    [Parameter] public string? CarriedReasoning { get; set; }
    [Parameter] public string? CarriedToolCalls { get; set; }

    private StreamingContent? _streamingContent;
    private string _previousTopicId = "";

    protected override void OnParametersSet()
    {
        if (_previousTopicId != TopicId)
        {
            _previousTopicId = TopicId;
            ResubscribeToTopic();
        }
    }

    private void ResubscribeToTopic()
    {
        ClearSubscriptions();

        if (string.IsNullOrEmpty(TopicId)) return;

        SubscribeWithInvoke(
            RenderCoordinator.CreateStreamingObservable(TopicId),
            content => _streamingContent = content);
    }
}

@if (_streamingContent is not null && HasDisplayableContent())
{
    <ChatMessage Message="@CreateMessageModel()" IsStreaming="true"/>
}

@code {

    private bool HasDisplayableContent()
    {
        return !string.IsNullOrEmpty(_streamingContent?.Content) ||
               !string.IsNullOrEmpty(_streamingContent?.Reasoning) ||
               !string.IsNullOrEmpty(_streamingContent?.ToolCalls) ||
               !string.IsNullOrEmpty(CarriedReasoning) ||
               !string.IsNullOrEmpty(CarriedToolCalls);
    }

}

@code {
    private ChatMessageModel CreateMessageModel() => new()
    {
        Role = "assistant",
        Content = _streamingContent?.Content ?? "",
        Reasoning = MergeField(CarriedReasoning, _streamingContent?.Reasoning, "\n-----\n"),
        ToolCalls = MergeField(CarriedToolCalls, _streamingContent?.ToolCalls, "\n"),
        IsError = _streamingContent?.IsError ?? false
    };

    private static string? MergeField(string? carried, string? live, string separator) =>
        (carried, live) switch
        {
            (null or "", null or "") => null,
            (null or "", _) => live,
            (_, null or "") => carried,
            _ => carried + separator + live
        };
}
