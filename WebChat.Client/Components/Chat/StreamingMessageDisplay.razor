@using WebChat.Client.Helpers
@inherits StoreSubscriberComponent
@inject RenderCoordinator RenderCoordinator

@code {
    [Parameter, EditorRequired] public string TopicId { get; set; } = "";
    [Parameter] public string? CarriedReasoning { get; set; }
    [Parameter] public string? CarriedToolCalls { get; set; }

    private StreamingContent? _streamingContent;
    private string _previousTopicId = "";

    protected override void OnParametersSet()
    {
        if (_previousTopicId != TopicId)
        {
            _previousTopicId = TopicId;
            ResubscribeToTopic();
        }
    }

    private void ResubscribeToTopic()
    {
        ClearSubscriptions();

        if (string.IsNullOrEmpty(TopicId)) return;

        SubscribeWithInvoke(
            RenderCoordinator.CreateStreamingObservable(TopicId),
            content => _streamingContent = content);
    }
}

@if (_streamingContent is not null && HasDisplayableContent())
{
    <ChatMessage Message="@CreateMessageModel()" IsStreaming="true"/>
}

@code {

    private bool HasDisplayableContent()
    {
        return !string.IsNullOrEmpty(_streamingContent?.Content) ||
               !string.IsNullOrEmpty(_streamingContent?.Reasoning) ||
               !string.IsNullOrEmpty(_streamingContent?.ToolCalls) ||
               !string.IsNullOrEmpty(CarriedReasoning) ||
               !string.IsNullOrEmpty(CarriedToolCalls);
    }

}

@code {
    private ChatMessageModel CreateMessageModel() => new()
    {
        Role = "assistant",
        Content = _streamingContent?.Content ?? "",
        Reasoning = MessageFieldMerger.Merge(
            CarriedReasoning, _streamingContent?.Reasoning, MessageFieldMerger.ReasoningSeparator),
        ToolCalls = MessageFieldMerger.Merge(
            CarriedToolCalls, _streamingContent?.ToolCalls, MessageFieldMerger.ToolCallsSeparator),
        IsError = _streamingContent?.IsError ?? false
    };

}
