@inherits StoreSubscriberComponent

@inject MessagesStore MessagesStore
@inject TopicsStore TopicsStore
@inject StreamingStore StreamingStore
@inject IDispatcher Dispatcher
@inject IJSRuntime Js

@code {
    private IReadOnlyList<ChatMessageModel> _messages = [];
    private string? _topicId;
    private bool _isStreaming;
    private AgentInfo? _selectedAgent;
    private ElementReference _messagesArea;
    private readonly bool _shouldAutoScroll = true;

    protected override void OnInitialized()
    {
        // Subscribe to selected topic ID
        Subscribe(TopicsStore.StateObservable,
            state => state.SelectedTopicId,
            id =>
            {
                _topicId = id;
                UpdateMessages();
                UpdateStreamingStatus();
            });

        // Subscribe to selected agent
        Subscribe(TopicsStore.StateObservable,
            state => state.Agents.FirstOrDefault(a => a.Id == state.SelectedAgentId),
            agent => _selectedAgent = agent);

        // Subscribe to messages for current topic
        Subscribe(MessagesStore.StateObservable,
            state => state,
            _ => UpdateMessages());

        // Subscribe to streaming status
        Subscribe(StreamingStore.StateObservable,
            state => state.StreamingTopics,
            _ => UpdateStreamingStatus());
    }

    private void UpdateMessages()
    {
        _messages = _topicId != null
            ? MessagesStore.State.MessagesByTopic.GetValueOrDefault(_topicId, [])
            : [];
    }

    private void UpdateStreamingStatus()
    {
        _isStreaming = _topicId != null && StreamingStore.State.StreamingTopics.Contains(_topicId);
    }

    private void HandleSuggestionClicked(string suggestion)
    {
        Dispatcher.Dispatch(new SendMessage(_topicId, suggestion));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldAutoScroll)
        {
            await Js.InvokeVoidAsync("chatScroll.scrollToBottom", _messagesArea, true);
        }
    }

}

<div class="messages-area" @ref="_messagesArea">
    @if (_messages.Count == 0 && !_isStreaming)
    {
        <EmptyState SelectedAgent="_selectedAgent" OnSuggestionClicked="HandleSuggestionClicked"/>
    }
    else
    {
        @foreach (var message in _messages)
        {
            <ChatMessage Message="@message"/>
        }

        @if (_isStreaming && !string.IsNullOrEmpty(_topicId))
        {
            <StreamingMessageDisplay TopicId="@_topicId"/>
        }
    }
</div>
