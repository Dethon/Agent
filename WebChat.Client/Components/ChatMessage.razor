@using Markdig
@code {
    [Parameter] public ChatMessageModel Message { get; set; } = new();

    private bool _showReasoning;
    private bool _showToolCalls;

    private string RenderMarkdown(string? content)
    {
        if (string.IsNullOrEmpty(content))
        {
            return "";
        }

        var pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .Build();

        return Markdown.ToHtml(content, pipeline);
    }

    private string GetMessageClass()
    {
        var classes = new List<string> { "chat-message", Message.Role };
        if (Message.IsError)
        {
            classes.Add("error");
        }

        return string.Join(" ", classes);
    }

}

<div class="@GetMessageClass()">
    @if (!string.IsNullOrEmpty(Message.Reasoning))
    {
        <div class="collapsible-block">
            <button class="collapsible-toggle" @onclick="() => _showReasoning = !_showReasoning">
                <span class="toggle-icon">@(_showReasoning ? "▼" : "▶")</span>
                Reasoning
            </button>
            @if (_showReasoning)
            {
                <div class="collapsible-content">
                    @Message.Reasoning
                </div>
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(Message.ToolCalls))
    {
        <div class="collapsible-block">
            <button class="collapsible-toggle" @onclick="() => _showToolCalls = !_showToolCalls">
                <span class="toggle-icon">@(_showToolCalls ? "▼" : "▶")</span>
                Tool calls
            </button>
            @if (_showToolCalls)
            {
                <div class="collapsible-content tool-calls-content">
                    @Message.ToolCalls
                </div>
            }
        </div>
    }

    <div class="message-content">
        @((MarkupString)RenderMarkdown(Message.Content))
    </div>
</div>
