@using Markdig
@inject UserIdentityStore UserIdentityStore

@code {
    [Parameter] public ChatMessageModel Message { get; set; } = new();
    [Parameter] public bool IsStreaming { get; set; }
    [Parameter] public bool ShowAvatar { get; set; }
    [Parameter] public bool IsOwnMessage { get; set; }

    private bool _showReasoning;
    private bool _showToolCalls;

    // Static pipeline to avoid allocation on every render
    private static readonly MarkdownPipeline MarkdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private static string RenderMarkdown(string? content)
    {
        return string.IsNullOrEmpty(content) ? "" : Markdown.ToHtml(content, MarkdownPipeline);
    }

    private (string? AvatarUrl, string DisplayName) GetSenderInfo()
    {
        if (string.IsNullOrEmpty(Message.SenderId))
            return (null, "Anonymous");

        var user = UserIdentityStore.State.AvailableUsers
            .FirstOrDefault(u => u.Id == Message.SenderId);

        return (user?.AvatarUrl, Message.SenderId);
    }

    private string GetMessageClass()
    {
        var classes = new List<string> { "chat-message", Message.Role };
        if (Message.IsError)
        {
            classes.Add("error");
        }
        // Add cursor class when actively streaming with content
        if (IsStreaming && !string.IsNullOrEmpty(Message.Content))
        {
            classes.Add("streaming-cursor");
        }
        // Compact styling when only showing thinking indicator
        if (IsStreaming && string.IsNullOrEmpty(Message.Content) &&
            string.IsNullOrEmpty(Message.Reasoning) && string.IsNullOrEmpty(Message.ToolCalls))
        {
            classes.Add("thinking-only");
        }
        // Add own message class for user's messages
        if (IsOwnMessage)
        {
            classes.Add("own");
        }

        return string.Join(" ", classes);
    }

    private string GetMessageWrapperClass()
    {
        var classes = new List<string> { "message-wrapper" };
        if (Message.Role == "assistant")
        {
            classes.Add("agent");
        }
        else
        {
            classes.Add("user");
        }
        return string.Join(" ", classes);
    }

    private string? GetTooltipText()
    {
        return Message.Role == "user" ? Message.SenderId : null;
    }

    private string? GetFormattedTimestamp()
    {
        if (Message.Timestamp is null)
        {
            return null;
        }

        var local = Message.Timestamp.Value.ToLocalTime();
        var now = DateTimeOffset.Now;

        // If today, show only time
        if (local.Date == now.Date)
        {
            return local.ToString("HH:mm");
        }

        // If this year, show day/month and time
        if (local.Year == now.Year)
        {
            return local.ToString("d MMM, HH:mm");
        }

        // Otherwise show full date with time
        return local.ToString("d MMM yyyy, HH:mm");
    }

}

<div class="@GetMessageWrapperClass()">
    @if (Message.Role != "assistant")
    {
        var (avatarUrl, displayName) = GetSenderInfo();
        <div class="message-avatar-column">
            @if (ShowAvatar)
            {
                <AvatarImage UserId="@displayName"
                             AvatarUrl="@avatarUrl"
                             Size="28" />
            }
            else
            {
                <div class="avatar-placeholder-space"></div>
            }
        </div>
    }

    <div class="@GetMessageClass()" title="@GetTooltipText()">
        @if (!string.IsNullOrEmpty(Message.Reasoning))
        {
            <div class="collapsible-block">
                <button class="collapsible-toggle" @onclick="() => _showReasoning = !_showReasoning">
                    <span class="toggle-icon">@(_showReasoning ? "▼" : "▶")</span>
                    Reasoning
                </button>
                @if (_showReasoning)
                {
                    <div class="collapsible-content">
                        @Message.Reasoning
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(Message.ToolCalls))
        {
            <div class="collapsible-block">
                <button class="collapsible-toggle" @onclick="() => _showToolCalls = !_showToolCalls">
                    <span class="toggle-icon">@(_showToolCalls ? "▼" : "▶")</span>
                    Tool calls
                </button>
                @if (_showToolCalls)
                {
                    <div class="collapsible-content tool-calls-content">
                        @Message.ToolCalls
                    </div>
                }
            </div>
        }

        <div class="message-content">
            @((MarkupString)RenderMarkdown(Message.Content))
        </div>

        @{
            var timestamp = GetFormattedTimestamp();
        }
        @if (!string.IsNullOrEmpty(timestamp))
        {
            <div class="message-timestamp">@timestamp</div>
        }

        @if (IsStreaming && string.IsNullOrEmpty(Message.Content))
        {
            <div class="typing-indicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span>Thinking...</span>
            </div>
        }
    </div>
</div>
