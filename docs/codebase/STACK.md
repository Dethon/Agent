# Technology Stack

> Auto-generated by /codemap-creator. Prescriptive guide for technology choices.

## Languages

- **Primary**: C# 14 (LangVersion 14)
  - Source: all `*.csproj` files declare `<LangVersion>14</LangVersion>`
- **Secondary**: JavaScript (Blazor WASM interop in `WebChat.Client/wwwroot/app.js`, stealth scripts in `Infrastructure/Clients/Browser/PlaywrightWebBrowser.cs`)

## Runtime

- **Runtime**: .NET 10.0 LTS
  - All projects target `net10.0`
  - Docker base image: `mcr.microsoft.com/dotnet/aspnet:10.0` / `mcr.microsoft.com/dotnet/sdk:10.0`
  - Source: `Agent/Dockerfile:1-2`
- **Package Manager**: NuGet (via `dotnet restore`)
  - Check `NUGET_PACKAGES` environment variable for cache location before assuming `~/.nuget/packages`
- **Solution file**: `agent.sln` (12 projects)

## Frameworks

### Web Framework
- **Use**: ASP.NET Core 10.0 (minimal APIs)
- **Agent entry point**: `Agent/Program.cs` -- composition root with `WebApplication.CreateBuilder`
- **WebChat server entry point**: `WebChat/Program.cs` -- Blazor WASM host with `/api/config`, `/api/spaces/{slug}`, dynamic `/manifest.webmanifest`, and `/icon.svg` endpoints
- **MCP server entry points**: `McpServer*/Program.cs` -- `WebApplication.CreateBuilder` + `app.MapMcp()`
- **Configuration**: `Agent/appsettings.json`, `McpServer*/appsettings.json`
- **User secrets**: Enabled for Agent, McpServerLibrary, McpServerWebSearch, McpServerMemory, McpServerIdealista, McpServerCommandRunner

### Real-Time Communication
- **Use**: ASP.NET Core SignalR
  - Package: `Microsoft.AspNetCore.SignalR.Client` 10.0.2
  - Hub: `Agent/Hubs/ChatHub.cs` -- central WebChat communication hub
  - Client-side: `WebChat.Client` uses `Microsoft.AspNetCore.SignalR.Client` 10.0.2
  - Route: `/hubs/chat` -- mapped in `Agent/Program.cs:32`
  - Group-based routing: Notifications scoped to SignalR groups by space (`space:{slug}`). Use `JoinSpace` hub method to subscribe a connection to a space group.
  - Notification adapter: `Agent/Hubs/HubNotificationAdapter.cs` -- implements `IHubNotificationSender`, supports both broadcast and group-targeted sends

### AI / LLM Framework
- **Use**: Microsoft.Extensions.AI 10.2.0 + Microsoft.Agents.AI 1.0.0-preview
  - `IChatClient` interface from `Microsoft.Extensions.AI`
  - `ChatClientAgent` from `Microsoft.Agents.AI` for agent orchestration
  - OpenAI SDK for OpenRouter API compatibility: `Infrastructure/Agents/ChatClients/OpenRouterChatClient.cs`
  - Source: `Infrastructure/Infrastructure.csproj:27-28`

### MCP (Model Context Protocol)
- **Use**: `ModelContextProtocol` 0.8.0-preview.1 / `ModelContextProtocol.AspNetCore` 0.8.0-preview.1
  - Client: `Infrastructure/Agents/Mcp/McpClientManager.cs` -- creates MCP clients connecting to SSE endpoints
  - Server: Each `McpServer*` project exposes tools via `app.MapMcp()`
  - Transport: HTTP/SSE (Server-Sent Events) via `HttpClientTransport`
  - Source: `Infrastructure/Infrastructure.csproj:30`

### Blazor WebAssembly
- **Use**: Blazor WASM (client-side) hosted by ASP.NET Core server
  - Client project: `WebChat.Client/WebChat.Client.csproj` (SDK: `Microsoft.NET.Sdk.BlazorWebAssembly`)
  - Server host: `WebChat/WebChat.csproj` with `Microsoft.AspNetCore.Components.WebAssembly.Server`
  - State management: Custom Redux-like pattern in `WebChat.Client/State/`
    - Stores: `WebChat.Client/State/*/` (Messages, Topics, Connection, Approval, Streaming, UserIdentity, Toast, Space)
    - Effects: `WebChat.Client/State/Effects/` (Initialization, SendMessage, TopicSelection, TopicDelete, AgentSelection, Reconnection, UserIdentity, Space)
    - Hub dispatcher: `WebChat.Client/State/Hub/HubEventDispatcher.cs`
    - Dispatcher returns `IDisposable` handler registrations for cleanup: `WebChat.Client/State/Dispatcher.cs`
  - Markdown rendering: `Markdig` 0.44.0
  - Reactive extensions: `System.Reactive` 6.1.0
  - Service worker: `WebChat.Client/wwwroot/service-worker.js`

### Resilience
- **Use**: Polly 8.6.5 + `Microsoft.Extensions.Http.Polly` 10.0.2
  - Retry policies on MCP client connections: `Infrastructure/Agents/Mcp/McpClientManager.cs:63-65`
  - Retry policies on download client: `Infrastructure/Clients/Torrent/QBittorrentDownloadClient.cs:52-56`
  - HTTP retry handler extensions: `Infrastructure/Extensions/HttpClientBuilderExtensions.cs`
  - Source: `Infrastructure/Infrastructure.csproj:32-33`

### Browser Automation
- **Use**: Microsoft.Playwright 1.58.0
  - Wrapper: `Infrastructure/Clients/Browser/PlaywrightWebBrowser.cs` -- implements `IWebBrowser`
  - Headless Chromium with stealth anti-detection scripts
  - Session management: `Infrastructure/Clients/Browser/BrowserSessionManager.cs`
  - CAPTCHA solving: `Infrastructure/Clients/Browser/CapSolverClient.cs` -- implements `ICaptchaSolver`
  - Modal dismissal: `Infrastructure/Clients/Browser/ModalDismisser.cs`
  - Source: `Infrastructure/Infrastructure.csproj:34`
  - Browsers installed at Docker runtime, not build time (`PlaywrightSkipBrowserDownload=true`)

### Testing
- **Use**: xUnit 2.9.3 + xunit.runner.visualstudio 3.1.5
  - Config: `Tests/Tests.csproj`
  - Runner config: `Tests/xunit.runner.json`
  - Run: `dotnet test Tests/Tests.csproj`
  - **Mocking**: Moq 4.20.72
  - **Assertions**: Shouldly 4.3.0
  - **Integration containers**: Testcontainers 4.10.0 + Testcontainers.ServiceBus 4.10.0
  - **HTTP mocking**: WireMock.Net 1.25.0
  - **MVC testing**: Microsoft.AspNetCore.Mvc.Testing 10.0.2
  - **Skippable tests**: Xunit.SkippableFact 1.5.61
  - **Coverage**: coverlet.collector 6.0.4
  - Source: `Tests/Tests.csproj`

### CLI / TUI
- **Use**: Spectre.Console 0.54.0 + Terminal.Gui 1.19.0
  - CLI routing: `Infrastructure/CliGui/Routing/`
  - Terminal UI adapter: `Infrastructure/CliGui/Ui/`
  - Command-line parsing: `System.CommandLine` 2.0.2 -- `Agent/Modules/ConfigModule.cs`
  - Source: `Infrastructure/Infrastructure.csproj:36-39`, `Agent/Agent.csproj:24`

### Result Types
- **Use**: FluentResults 4.0.0
  - Source: `Domain/Domain.csproj:11`

### Scheduling
- **Use**: NCrontab 3.4.0 for cron expression parsing
  - Source: `Domain/Domain.csproj:17`
  - Scheduling module: `Agent/Modules/SchedulingModule.cs`
  - Schedule persistence: `Infrastructure/StateManagers/RedisScheduleStore.cs`

### Code Annotations
- **Use**: JetBrains.Annotations 2025.2.4
  - Source: `Domain/Domain.csproj:12`

### HTML Processing
- **Use**: SmartReader 0.11.0 (readable content extraction)
  - Source: `Infrastructure/Infrastructure.csproj:35`
  - Processing pipeline: `Infrastructure/HtmlProcessing/`

## Build & Development

- **Build tool**: .NET SDK (`dotnet build`)
- **Build**: `dotnet build agent.sln`
- **Dev server**: `dotnet run --project Agent -- --chat Web`
- **CLI mode**: `dotnet run --project Agent -- --chat Cli`
- **One-shot mode**: `dotnet run --project Agent -- --prompt "your prompt"`
- **Telegram mode**: `dotnet run --project Agent -- --chat Telegram`
- **Type checking**: Built into C# compiler (nullable reference types enabled in all projects)
- **Containerization**: Docker Compose at `DockerCompose/docker-compose.yml`
  - Build all: from `DockerCompose/` directory, `docker compose build`
  - Run all: from `DockerCompose/` directory, `docker compose up -d`
- **IDE**: JetBrains Rider (shared run configurations at `.run-docker-compose/`)

## Code Quality

- **EditorConfig**: `.editorconfig` -- comprehensive C# style rules
  - Indent: 4 spaces for C# code, 2 spaces for XML/csproj files
  - File-scoped namespaces: enforced (`csharp_style_namespace_declarations = file_scoped:warning`)
  - Braces: required for all control flow (`csharp_prefer_braces = true:warning`)
  - Naming: `_camelCase` for fields, `PascalCase` for types/members, `I` prefix for interfaces
  - Line endings: CRLF
  - Max line length: 120 characters
- **Formatter**: EditorConfig-based (enforced by IDE / `dotnet format`)
- **Additional Rider rules**: Resharper settings in `.editorconfig` (brace style, wrap rules, null checks)
