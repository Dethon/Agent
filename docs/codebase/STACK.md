# Technology Stack

> Auto-generated by /codemap-creator. Prescriptive guide for technology choices.

## Languages

- **Primary**: C# 14 (LangVersion 14)
  - Source: every `*.csproj` file declares `<LangVersion>14</LangVersion>`
  - Uses modern features: file-scoped namespaces, primary constructors, extension blocks, records, nullable reference types
- **Secondary**: HTML/CSS/JavaScript (Blazor WebAssembly client-side)

## Runtime

- **Runtime**: .NET 10 LTS (`net10.0`)
  - Source: `<TargetFramework>net10.0</TargetFramework>` in all `*.csproj` files
  - Docker base image: `mcr.microsoft.com/dotnet/aspnet:10.0` / `mcr.microsoft.com/dotnet/sdk:10.0`
    - Source: `Agent/Dockerfile:1-2`, `Agent/Dockerfile:6`
- **Package Manager**: NuGet
  - No lock file; restore happens at build time via `dotnet restore`
- **Solution**: `agent.sln` (root-level solution file)

## Frameworks

### Web Framework
- **Use**: ASP.NET Core (minimal APIs + SignalR)
- **Agent entry point**: `Agent/Program.cs` -- `WebApplication.CreateBuilder(args)` with SignalR hub
- **WebChat entry point**: `WebChat/Program.cs` -- serves Blazor WASM, static files, and minimal API endpoints
- **MCP server entry points**: each `McpServer*/Program.cs` uses `WebApplication.CreateBuilder(args)` + `app.MapMcp()`

### Blazor WebAssembly (WebChat frontend)
- **Use**: Blazor WebAssembly (`Microsoft.NET.Sdk.BlazorWebAssembly`)
  - Source: `WebChat.Client/WebChat.Client.csproj:1`
- **State management**: Custom Redux-like pattern with Stores, Reducers, Actions, Effects, Dispatcher
  - Source: `WebChat.Client/State/` -- `Store.cs`, `Dispatcher.cs`, `IAction.cs`, `IDispatcher.cs`
- **SignalR client**: `Microsoft.AspNetCore.SignalR.Client` 10.0.2
  - Source: `WebChat.Client/WebChat.Client.csproj:13`
- **Markdown rendering**: `Markdig` 0.44.0
  - Source: `WebChat.Client/WebChat.Client.csproj:14`
- **Reactive extensions**: `System.Reactive` 6.1.0
  - Source: `WebChat.Client/WebChat.Client.csproj:15`
- **PWA**: Service worker configured via `ServiceWorkerAssetsManifest`
  - Source: `WebChat.Client/WebChat.Client.csproj:8`, `WebChat.Client/wwwroot/service-worker.js`

### AI / LLM Framework
- **Use**: Microsoft.Extensions.AI 10.2.0 + Microsoft.Agents.AI 1.0.0-preview
  - Source: `Infrastructure/Infrastructure.csproj:27-28`, `Domain/Domain.csproj:13-14`
  - `IChatClient` interface from `Microsoft.Extensions.AI` for all LLM interactions
  - `ChatClientAgent` / `DisposableAgent` from `Microsoft.Agents.AI` for agent orchestration
- **LLM provider**: OpenRouter API (OpenAI-compatible)
  - Client wrapper: `Infrastructure/Agents/ChatClients/OpenRouterChatClient.cs`
  - Uses `OpenAI` SDK under the hood pointed at OpenRouter endpoint
  - Source: `Infrastructure/Infrastructure.csproj:28` (`Microsoft.Extensions.AI.OpenAI` 10.2.0-preview)
- **MCP Protocol**: `ModelContextProtocol` 0.8.0-preview.1 (client) / `ModelContextProtocol.AspNetCore` 0.8.0-preview.1 (server)
  - Source: `Infrastructure/Infrastructure.csproj:30`, `McpServerLibrary/McpServerLibrary.csproj:24`
  - Client manager: `Infrastructure/Agents/Mcp/McpClientManager.cs`
  - Transport: HTTP SSE (`HttpClientTransport`)

### Resilience
- **Use**: Polly 8.6.5 + Polly.Extensions.Http 3.0.0
  - Source: `Infrastructure/Infrastructure.csproj:32-33`
  - Used for MCP client connection retries (`McpClientManager.cs:63-65`)
  - Used for download status polling (`QBittorrentDownloadClient.cs:52-56`)
- **HTTP resilience**: `Microsoft.Extensions.Http.Polly` 10.0.2
  - Source: `Infrastructure/Infrastructure.csproj:29`

### Browser Automation
- **Use**: Microsoft.Playwright 1.58.0 (Chromium, headless)
  - Source: `Infrastructure/Infrastructure.csproj:34`
  - Wrapper: `Infrastructure/Clients/Browser/PlaywrightWebBrowser.cs` -- implements `IWebBrowser`
  - Session manager: `Infrastructure/Clients/Browser/BrowserSessionManager.cs`
  - Stealth mode with anti-detection scripts baked in

### Testing
- **Use**: xUnit 2.9.3
  - Source: `Tests/Tests.csproj:24`
  - Runner: `xunit.runner.visualstudio` 3.1.5
  - Config: `Tests/xunit.runner.json`
- **Assertions**: Shouldly 4.3.0
  - Source: `Tests/Tests.csproj:20`
- **Mocking**: Moq 4.20.72
  - Source: `Tests/Tests.csproj:19`
- **HTTP mocking**: WireMock.Net 1.25.0
  - Source: `Tests/Tests.csproj:23`
- **Integration containers**: Testcontainers 4.10.0 + Testcontainers.ServiceBus 4.10.0
  - Source: `Tests/Tests.csproj:21-22`
- **Code coverage**: coverlet.collector 6.0.4
  - Source: `Tests/Tests.csproj:13`
- **Integration testing**: `Microsoft.AspNetCore.Mvc.Testing` 10.0.2
  - Source: `Tests/Tests.csproj:46`
- **Skippable tests**: `Xunit.SkippableFact` 1.5.61
  - Source: `Tests/Tests.csproj:29`
- **Run tests**: `dotnet test`

### Scheduling
- **Use**: NCrontab 3.4.0 for cron expression parsing
  - Source: `Domain/Domain.csproj:17`
  - Registration: `Agent/Modules/SchedulingModule.cs`
  - Hosted service: `Agent/App/ScheduleMonitoring.cs`

### Result Pattern
- **Use**: FluentResults 4.0.0
  - Source: `Domain/Domain.csproj:11`

### CLI Interface
- **Use**: System.CommandLine 2.0.2
  - Source: `Agent/Agent.csproj:24`
  - Parser: `Agent/Modules/ConfigModule.cs:28-71`
- **Terminal UI**: Terminal.Gui 1.19.0 + Spectre.Console 0.54.0
  - Source: `Infrastructure/Infrastructure.csproj:36-39`

### Static Analysis
- **Use**: JetBrains.Annotations 2025.2.4 for `[UsedImplicitly]`, `[PublicAPI]`
  - Source: `Domain/Domain.csproj:12`

## Build & Development

- **Build tool**: .NET SDK (`dotnet build`)
- **Build**: `dotnet build agent.sln`
- **Run agent**: `dotnet run --project Agent`
- **Run tests**: `dotnet test Tests/Tests.csproj`
- **Docker build**: Multi-stage Dockerfiles per project (e.g., `Agent/Dockerfile`)
  - Uses NuGet cache mount: `--mount=type=cache,target=/root/.nuget/packages,sharing=locked`
- **Docker Compose**: `DockerCompose/docker-compose.yml` with OS-specific overrides
  - Linux: `DockerCompose/docker-compose.override.linux.yml`
  - Windows: `DockerCompose/docker-compose.override.windows.yml`
  - Env file: `DockerCompose/.env`
- **Dev container**: `.devcontainer/Dockerfile` + `.devcontainer/docker-compose.yml`
- **Reverse proxy**: Caddy 2 -- `DockerCompose/Caddyfile`
  - HTTPS (Let's Encrypt DNS-01) on port 443, routes `/hubs/*` to agent, everything else to webui

## Code Quality

- **Code style**: `.editorconfig` (root-level, comprehensive)
  - File-scoped namespaces: `csharp_style_namespace_declarations = file_scoped:warning`
  - Braces required: `csharp_prefer_braces = true:warning`
  - 4-space indent for C# code, 2-space for XML/config
  - Private fields: `_camelCase` prefix convention
  - Max line length: 120 characters
- **IDE support**: JetBrains Rider conventions embedded in `.editorconfig` (Resharper rules)
- **Nullable reference types**: Enabled in all projects (`<Nullable>enable</Nullable>`)
- **Implicit usings**: Enabled in all projects (`<ImplicitUsings>enable</ImplicitUsings>`)

## Configuration

- **Pattern**: .NET Configuration (appsettings.json + User Secrets + Environment Variables)
  - Agent settings: `Agent/Settings/AgentSettings.cs` -- bound from `Agent/appsettings.json`
  - Each MCP server has its own `appsettings.json`
- **User Secrets**: Used for sensitive values (API keys, connection strings)
  - Mounted into Docker containers at `/home/app/.microsoft/usersecrets`
  - Source: `DockerCompose/docker-compose.override.linux.yml`, `DockerCompose/docker-compose.override.windows.yml`
- **Environment variables**: Override configuration via Docker Compose `env_file: .env`
