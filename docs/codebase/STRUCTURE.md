# Code Structure

> Auto-generated by /codemap-creator. Prescriptive guide for file organization.

## Directory Overview

```
Agent/                              # Solution root
|
+-- Agent/                          # Composition root (ASP.NET Web host, DI, entry point)
|   +-- App/                        # BackgroundService hosted services
|   +-- Hubs/                       # SignalR hubs and adapters
|   +-- Modules/                    # DI registration modules
|   +-- Settings/                   # Strongly-typed configuration records
|   +-- Program.cs                  # Application entry point
|
+-- Domain/                         # Pure business logic (no external dependencies)
|   +-- Agents/                     # Agent abstractions (AgentKey, DisposableAgent, ChatThreadResolver)
|   +-- Contracts/                  # Interfaces consumed by Domain and implemented by Infrastructure
|   +-- DTOs/                       # Data transfer objects and value types
|   |   +-- WebChat/                # DTOs shared between WebChat.Client and Agent
|   +-- Extensions/                 # Extension methods on framework types
|   +-- Monitor/                    # Chat monitoring and schedule execution logic
|   +-- Prompts/                    # System prompt templates for agents
|   +-- Resources/                  # Domain resource definitions (e.g., DownloadResource)
|   +-- Routers/                    # Message routing logic
|   +-- Tools/                      # Domain tool implementations (business logic only)
|       +-- Commands/               # CLI command tools
|       +-- Config/                 # Tool configuration records
|       +-- Downloads/              # File download tools
|       +-- Files/                  # File system tools (glob, move, remove)
|       +-- Memory/                 # Memory store/recall tools
|       +-- RealEstate/             # Property search tools
|       +-- Scheduling/             # Schedule CRUD tools + feature registration
|       +-- Text/                   # Text file CRUD tools
|       +-- Web/                    # Web browsing/search tools
|
+-- Infrastructure/                 # External integrations and interface implementations
|   +-- Agents/                     # Agent implementations
|   |   +-- ChatClients/            # LLM chat client wrappers (OpenRouter, ToolApproval, Redis store)
|   |   +-- Mappers/                # Response mapping extensions
|   |   +-- Mcp/                    # MCP client management (connections, tools, resources, sampling)
|   +-- CliGui/                     # Terminal UI components
|   |   +-- Abstractions/           # CLI interface contracts
|   |   +-- Rendering/              # Chat message formatting and display
|   |   +-- Routing/                # CLI command routing
|   |   +-- Ui/                     # Terminal.Gui widgets and adapters
|   +-- Clients/                    # External service clients
|   |   +-- Browser/                # Playwright web browser automation
|   |   +-- Messaging/              # Chat transport implementations
|   |   |   +-- Cli/                # CLI messenger client
|   |   |   +-- ServiceBus/         # Azure Service Bus messenger
|   |   |   +-- Telegram/           # Telegram bot client
|   |   |   +-- WebChat/            # WebChat messenger, sessions, streams, approvals
|   |   +-- ToolApproval/           # Tool approval handler implementations
|   |   +-- Torrent/                # Jackett search + qBittorrent download clients
|   +-- CommandRunners/             # Shell command execution (Bash, PowerShell, Cmd, Sh)
|   +-- Extensions/                 # Infrastructure extension methods
|   +-- HtmlProcessing/             # HTML-to-markdown conversion and inspection
|   +-- Memory/                     # Embedding service and Redis vector store
|   +-- Middleware/                  # ASP.NET middleware (DDNS IP allowlist)
|   +-- StateManagers/              # Redis-backed state stores (threads, schedules, search results)
|   +-- Utils/                      # Shared utilities (ToolResponse, ToolPatternMatcher, TopicIdHasher)
|   +-- Validation/                 # Validators (CronValidator)
|
+-- McpServerLibrary/               # MCP server: media library (downloads, file search, organize)
|   +-- McpPrompts/                 # Server-specific system prompts
|   +-- McpResources/               # MCP resource providers
|   +-- McpTools/                   # MCP tool wrappers (inherit Domain tools)
|   +-- Modules/                    # DI registration
|   +-- ResourceSubscriptions/      # Subscription tracking and monitoring
|   +-- Settings/                   # Server-specific config
|   +-- Program.cs
|
+-- McpServerText/                  # MCP server: text file operations (read, write, edit, search)
|   +-- McpPrompts/
|   +-- McpTools/
|   +-- Modules/
|   +-- Settings/
|   +-- Program.cs
|
+-- McpServerWebSearch/             # MCP server: web search and browsing
|   +-- McpPrompts/
|   +-- McpTools/
|   +-- Modules/
|   +-- Settings/
|   +-- Program.cs
|
+-- McpServerMemory/                # MCP server: semantic memory (store, recall, reflect)
|   +-- McpPrompts/
|   +-- McpTools/
|   +-- Modules/
|   +-- Settings/
|   +-- Program.cs
|
+-- McpServerIdealista/             # MCP server: real estate search
|   +-- McpPrompts/
|   +-- McpTools/
|   +-- Modules/
|   +-- Settings/
|   +-- Program.cs
|
+-- McpServerCommandRunner/         # MCP server: shell command execution
|   +-- McpTools/
|   +-- Modules/
|   +-- Settings/
|   +-- Program.cs
|
+-- WebChat/                        # Blazor Server host (serves static files + config API)
|   +-- Program.cs
|
+-- WebChat.Client/                 # Blazor WebAssembly client application
|   +-- Components/                 # Razor components
|   |   +-- Chat/                   # Chat-specific components (container, message list, streaming)
|   |   +-- Toast/                  # Toast notification components
|   +-- Contracts/                  # Client-side service interfaces
|   +-- Extensions/                 # Client extension methods
|   +-- Helpers/                    # UI helpers (avatar, message merge)
|   +-- Layout/                     # Layout components (MainLayout)
|   +-- Models/                     # Client-side models (ChatMessageModel, StoredTopic, UserConfig)
|   +-- Pages/                      # Routable pages
|   +-- Services/                   # Service implementations
|   |   +-- Streaming/              # Stream resume, buffer rebuild, transient error handling
|   |   +-- Utilities/              # Service utilities (TopicIdGenerator)
|   +-- State/                      # Redux-like state management
|       +-- Approval/               # Approval state (Actions, Reducers, State, Store)
|       +-- Connection/             # Connection state
|       +-- Effects/                # Side-effect handlers (init, send message, topic selection, etc.)
|       +-- Hub/                    # SignalR event dispatching to state
|       +-- Messages/               # Messages state
|       +-- Pipeline/               # Message pipeline (batching, deduplication)
|       +-- Streaming/              # Streaming state + selectors
|       +-- Toast/                  # Toast notification state
|       +-- Topics/                 # Topics state
|       +-- UserIdentity/           # User identity state
|
+-- Tests/                          # All tests (unit + integration)
|   +-- Unit/                       # Unit tests
|   |   +-- Domain/                 # Domain logic tests
|   |   +-- Infrastructure/         # Infrastructure implementation tests
|   |   +-- McpServerLibrary/       # MCP server-specific tests
|   |   +-- Tools/                  # Tool-specific tests
|   |   +-- WebChat/                # WebChat server-side tests
|   |   +-- WebChat.Client/         # WebChat client-side tests
|   +-- Integration/                # Integration tests
|       +-- Agents/                 # Agent integration tests (MCP, OpenRouter, ThreadSession)
|       +-- Clients/                # External client integration tests
|       +-- Domain/                 # Domain integration tests
|       +-- Fixtures/               # Shared test fixtures (Redis, ServiceBus, Playwright, etc.)
|       +-- Infrastructure/         # Infrastructure integration tests
|       +-- Jack/                   # DI container validation tests
|       +-- McpServerTests/         # MCP server integration tests
|       +-- McpTools/               # MCP tool integration tests
|       +-- Memory/                 # Memory store integration tests
|       +-- Messaging/              # Service Bus integration tests
|       +-- StateManagers/          # Redis state manager integration tests
|       +-- WebChat/                # WebChat + SignalR integration tests
|
+-- DockerCompose/                  # Docker Compose deployment configuration
    +-- docker-compose.yml
    +-- docker-compose.override.yml
    +-- Caddyfile                   # Reverse proxy configuration
```

## File Naming Conventions

| Type | Pattern | Example |
|------|---------|---------|
| Domain contracts | `I{Name}.cs` | `IChatMessengerClient.cs` |
| Domain DTOs | `{Name}.cs` (record) | `AgentDefinition.cs` |
| Domain tools | `{Feature}{Action}Tool.cs` | `FileDownloadTool.cs`, `MemoryStoreTool.cs` |
| Domain tool features | `{Feature}ToolFeature.cs` | `SchedulingToolFeature.cs` |
| Prompts | `{Name}Prompt.cs` | `BasePrompt.cs`, `WebBrowsingPrompt.cs` |
| MCP tool wrappers | `Mcp{DomainToolName}.cs` | `McpFileDownloadTool.cs` |
| MCP prompts | `McpSystemPrompt.cs` | `McpSystemPrompt.cs` |
| Infrastructure clients | `{Service}Client.cs` | `BraveSearchClient.cs`, `IdealistaClient.cs` |
| State stores | `Redis{Name}Store.cs` | `RedisThreadStateStore.cs`, `RedisScheduleStore.cs` |
| Settings records | `{Name}Settings.cs` | `AgentSettings.cs`, `McpSettings.cs` |
| DI modules | `ConfigModule.cs`, `InjectorModule.cs` | `Agent/Modules/ConfigModule.cs` |
| Background services | `{Name}Monitoring.cs` | `ChatMonitoring.cs`, `ScheduleMonitoring.cs` |
| WebChat stores | `{Feature}Store.cs` | `MessagesStore.cs`, `StreamingStore.cs` |
| WebChat actions | `{Feature}Actions.cs` | `MessagesActions.cs` |
| WebChat reducers | `{Feature}Reducers.cs` | `MessagesReducers.cs` |
| WebChat state records | `{Feature}State.cs` | `MessagesState.cs` |
| WebChat effects | `{Feature}Effect.cs` | `SendMessageEffect.cs` |
| Unit tests | `{ClassUnderTest}Tests.cs` | `ToolPatternMatcherTests.cs` |
| Integration tests | `{Feature}IntegrationTests.cs` | `McpAgentIntegrationTests.cs` |
| Test fixtures | `{Service}Fixture.cs` | `RedisFixture.cs`, `ServiceBusFixture.cs` |

## Where to Put New Code

### Adding a new Domain tool

1. Create the tool class in `Domain/Tools/{Category}/{ToolName}Tool.cs` with protected `Name` and `Description` constants and a protected `Run()` method
2. If the tool needs a new external service, define the interface in `Domain/Contracts/I{Service}.cs`
3. Implement the interface in `Infrastructure/Clients/{Service}.cs`
4. Create the MCP wrapper in the appropriate `McpServer*/McpTools/Mcp{ToolName}Tool.cs` -- inherit from the Domain tool, add `[McpServerToolType]` and `[McpServerTool]` attributes
5. Register the MCP tool in the server's `Modules/ConfigModule.cs` via `.WithTools<McpToolName>()`
6. Write unit tests in `Tests/Unit/Domain/{ToolName}Tests.cs`

### Adding a new Domain tool feature (DI-injected tools)

1. Create tool classes in `Domain/Tools/{Feature}/`
2. Create a feature class implementing `IDomainToolFeature` in `Domain/Tools/{Feature}/{Feature}ToolFeature.cs`
3. Register in `Agent/Modules/SchedulingModule.cs` (or a new module): `services.AddTransient<IDomainToolFeature, {Feature}ToolFeature>()`
4. Add the feature name to the agent's `EnabledFeatures` in configuration
5. Write tests in `Tests/Unit/Domain/{Feature}/`

### Adding a new MCP server

1. Create `McpServer{Name}/` directory at solution root
2. Add `McpServer{Name}.csproj` with `ProjectReference` to `Infrastructure`
3. Add `Program.cs` following the pattern in `McpServerLibrary/Program.cs`
4. Add `Modules/ConfigModule.cs` for DI and MCP tool registration
5. Add `McpTools/` with tool wrappers inheriting Domain tools
6. Add `Settings/McpSettings.cs` for configuration
7. Add a service entry in `DockerCompose/docker-compose.yml`
8. Add the endpoint to agent definitions in configuration

### Adding a new chat interface

1. Implement `IChatMessengerClient` in `Infrastructure/Clients/Messaging/{Interface}/`
2. Implement `IToolApprovalHandler` in `Infrastructure/Clients/ToolApproval/{Interface}ToolApprovalHandler.cs`
3. Add a case to the `ChatInterface` enum in `Agent/Settings/CommandLineParams.cs`
4. Add registration in `Agent/Modules/InjectorModule.cs` (new `Add{Interface}Client()` method + switch case in `AddChatMonitoring()`)

### Adding a new WebChat state feature

1. Create `WebChat.Client/State/{Feature}/` directory
2. Add `{Feature}Actions.cs` -- define action records implementing `IAction`
3. Add `{Feature}State.cs` -- define the immutable state record
4. Add `{Feature}Reducers.cs` -- static pure reducer functions
5. Add `{Feature}Store.cs` -- typed store extending `Store<{Feature}State>`, registers reducers in constructor
6. If side effects are needed, add `WebChat.Client/State/Effects/{Feature}Effect.cs`
7. Register the store in `WebChat.Client/Extensions/ServiceCollectionExtensions.cs`
8. Write tests in `Tests/Unit/WebChat.Client/State/{Feature}StoreTests.cs`

### Adding a utility

- Shared across Infrastructure: place in `Infrastructure/Utils/{Name}.cs`
- Shared across Domain: place in `Domain/Extensions/{Name}Extensions.cs`
- Feature-specific: keep in the feature directory

### Adding configuration

- Agent-level settings: add property to `Agent/Settings/AgentSettings.cs`
- MCP server settings: add property to `McpServer*/Settings/McpSettings.cs`
- Per-agent settings: add property to `Domain/DTOs/AgentDefinition.cs`
- Environment-based: use `IConfiguration` binding in `ConfigModule.cs`

## Module Boundaries

### Project References (Dependency Graph)

```
Agent ──> Infrastructure ──> Domain
McpServer* ──> Infrastructure ──> Domain
WebChat ──> Infrastructure, Domain, WebChat.Client
WebChat.Client ──> Domain
Tests ──> Agent, Infrastructure, McpServerLibrary, McpServerMemory, McpServerWebSearch, WebChat.Client
```

### Import Rules

```csharp
// CORRECT: Domain has no project references
// Domain/Tools/Downloads/FileDownloadTool.cs
using Domain.Contracts;
using Domain.Tools.Config;

// CORRECT: Infrastructure references only Domain
// Infrastructure/Agents/McpAgent.cs
using Domain.Agents;
using Domain.Contracts;
using Infrastructure.Agents.ChatClients;

// CORRECT: MCP server references Infrastructure
// McpServerLibrary/McpTools/McpFileDownloadTool.cs
using Domain.Tools.Downloads;
using Infrastructure.Utils;
using ModelContextProtocol.Server;

// FORBIDDEN: Domain referencing Infrastructure
// Domain/SomeClass.cs
using Infrastructure.Clients;  // VIOLATION - will not compile

// FORBIDDEN: Infrastructure referencing Agent
// Infrastructure/SomeClass.cs
using Agent.Modules;  // VIOLATION - will not compile
```

## Entry Points

| Purpose | File |
|---------|------|
| Agent application start | `Agent/Program.cs` |
| Agent DI orchestration | `Agent/Modules/ConfigModule.cs:ConfigureAgents()` |
| Agent service registration | `Agent/Modules/InjectorModule.cs` |
| Scheduling registration | `Agent/Modules/SchedulingModule.cs` |
| Chat monitoring loop | `Agent/App/ChatMonitoring.cs` -> `Domain/Monitor/ChatMonitor.cs` |
| Schedule monitoring loop | `Agent/App/ScheduleMonitoring.cs` |
| SignalR hub | `Agent/Hubs/ChatHub.cs` (mapped at `/hubs/chat`) |
| WebChat server start | `WebChat/Program.cs` |
| WebChat client start | `WebChat.Client/Program.cs` |
| MCP Library server start | `McpServerLibrary/Program.cs` |
| MCP Text server start | `McpServerText/Program.cs` |
| MCP WebSearch server start | `McpServerWebSearch/Program.cs` |
| MCP Memory server start | `McpServerMemory/Program.cs` |
| MCP Idealista server start | `McpServerIdealista/Program.cs` |
| MCP CommandRunner server start | `McpServerCommandRunner/Program.cs` |

## Test Organization

```
Tests/
+-- Unit/
|   +-- Domain/                           # Domain logic (tools, DTOs, monitor, threading)
|   |   +-- Scheduling/                   # Schedule tool unit tests
|   |   +-- Text/                         # Text tool unit tests
|   +-- Infrastructure/                   # Infrastructure implementations
|   |   +-- Cli/                          # CLI router tests
|   |   +-- Memory/                       # Memory entry tests
|   |   +-- Messaging/                    # All messenger client + ServiceBus tests
|   +-- McpServerLibrary/                 # MCP server-specific unit tests
|   +-- Tools/                            # Standalone tool tests
|   +-- WebChat/                          # WebChat server-side tests
|   |   +-- Client/                       # Client-side service tests
|   |   +-- Fixtures/                     # Fake service implementations
|   +-- WebChat.Client/                   # WebChat.Client state + service tests
|       +-- Services/                     # Service unit tests
|       +-- State/                        # Store + effect unit tests
|           +-- Pipeline/                 # Message pipeline tests
+-- Integration/
    +-- Agents/                           # McpAgent, ThreadSession, ToolApproval integration
    +-- Clients/                          # External client integration (Brave, Jackett, qBittorrent, Playwright, Telegram)
    +-- Domain/                           # Domain integration tests
    +-- Fixtures/                         # Shared fixtures (Redis, ServiceBus, Playwright, MCP servers, WebChat)
    +-- Infrastructure/                   # LocalFileSystem integration
    +-- Jack/                             # DI container validation
    +-- McpServerTests/                   # MCP server endpoint integration tests
    +-- McpTools/                         # MCP tool integration tests
    +-- Memory/                           # Embedding + Redis memory store integration
    +-- Messaging/                        # ServiceBus integration
    +-- StateManagers/                    # Redis state manager integration
    +-- WebChat/                          # ChatHub + SignalR integration
        +-- Client/                       # Client-side streaming/resume integration
```

### Test Frameworks and Libraries

| Library | Purpose |
|---------|---------|
| xUnit | Test framework |
| Moq | Mocking |
| Shouldly | Assertion library |
| WireMock.Net | HTTP mocking for integration tests |
| Testcontainers | Docker-based integration test infrastructure (Redis, ServiceBus) |
| Microsoft.AspNetCore.Mvc.Testing | In-process server testing |

### Test Naming Convention

Place test files to mirror the source structure: `Tests/Unit/{Project}/{Path}/{ClassUnderTest}Tests.cs`. For example, `Infrastructure/Agents/ChatClients/ToolApprovalChatClient.cs` is tested in `Tests/Unit/Infrastructure/ToolApprovalChatClientTests.cs`.
