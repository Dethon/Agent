# External Integrations

> Auto-generated by /codemap-creator. Prescriptive guide for external service usage.

## Databases / State

### Redis Stack (primary data store)
- **Connection**: `Agent/Modules/InjectorModule.cs:81-89` -- `ConnectionMultiplexer.Connect()`
  - Registered as `IConnectionMultiplexer` singleton
- **Client library**: `StackExchange.Redis` 2.10.14 + `NRedisStack` 1.2.0
  - Source: `Infrastructure/Infrastructure.csproj:37,31`
- **Usage pattern**: Direct `IDatabase` access through Redis abstractions
  - Thread/conversation state: `Infrastructure/StateManagers/RedisThreadStateStore.cs` -- implements `IThreadStateStore`
  - Schedule persistence: `Infrastructure/StateManagers/RedisScheduleStore.cs` -- implements `IScheduleStore`
  - Memory store with vector search: `Infrastructure/Memory/RedisStackMemoryStore.cs` -- implements `IMemoryStore`
    - Uses RediSearch for HNSW vector similarity (COSINE, 1536-dim)
    - Index: `idx:memories` on `memory:*` keys
- **Key patterns**:
  - Conversation threads: `{agentId}:{chatId}:{threadId}` (JSON-serialized `ChatMessage[]`)
  - Topics: `topic:{agentId}:{chatId}:{topicId}`
  - Schedules: `schedule:{id}`, set `schedules`, sorted set `schedules:due`
  - Memories: `memory:{userId}:{memoryId}` (hash)
  - Profiles: `memory:profile:{userId}`
- **Expiration**: Configurable, default 30 days for thread state (`RedisConfiguration.ExpirationDays`); 365 days for memories
- **Environment variable**: `REDISCONNECTIONSTRING` (for MCP Memory server), `redis.connectionString` in `Agent/appsettings.json`

## LLM Provider

### OpenRouter (LLM gateway)
- **Client wrapper**: `Infrastructure/Agents/ChatClients/OpenRouterChatClient.cs` -- implements `IChatClient`
  - Use this, not the raw `OpenAI` SDK directly
  - Wraps the official `OpenAI` .NET SDK (`OpenAIClient`) pointed at the OpenRouter endpoint
  - Custom `ReasoningHandler` for extracting `reasoning` content from SSE streams
  - Source: `Infrastructure/Agents/ChatClients/OpenRouterHttpHelpers.cs` for SSE parsing
- **Configuration**: `Agent/appsettings.json` section `"openRouter"`
  - `apiUrl`: `https://openrouter.ai/api/v1/`
  - `apiKey`: from User Secrets
- **Environment variables**: `OPENROUTER__APIKEY`
- **Models**: Configured per agent in `Agent/appsettings.json` `"agents[].model"` field
- **Embeddings**: `Infrastructure/Memory/OpenRouterEmbeddingService.cs` -- implements `IEmbeddingService`
  - Endpoint: `{baseUrl}/embeddings`
  - Model: `openai/text-embedding-3-small` (configured in `McpServerMemory/appsettings.json`)
  - Environment variable: `OPENROUTER__APIKEY`

## Messaging / Chat Interfaces

### Telegram Bot API
- **Client library**: `Telegram.Bot` 22.8.1
  - Source: `Infrastructure/Infrastructure.csproj:38`
- **Wrapper**: `Infrastructure/Clients/Messaging/Telegram/TelegramChatClient.cs` -- implements `IChatMessengerClient`
  - Helper: `Infrastructure/Clients/Messaging/Telegram/TelegramBotHelper.cs`
- **Multi-bot support**: Each agent can have its own Telegram bot token
  - Configured via `Agent/appsettings.json` `"agents[].telegramBotToken"`
- **Tool approval**: `Infrastructure/Clients/ToolApproval/TelegramToolApprovalHandler.cs` (inline keyboard callbacks)
- **Authorization**: Allowlisted usernames via `"telegram.allowedUserNames"`
- **Environment variables**:
  - `JACK__TELEGRAM__BOTTOKEN` (agent-specific)
  - `JONAS__TELEGRAM__BOTTOKEN` (agent-specific)
  - `TELEGRAM__ALLOWEDUSERNAMES__0`, `TELEGRAM__ALLOWEDUSERNAMES__1`

### SignalR (WebChat real-time communication)
- **Hub**: `Agent/Hubs/ChatHub.cs` -- mapped at `/hubs/chat`
  - Source: `Agent/Program.cs:32`
- **Client**: `WebChat.Client` uses `Microsoft.AspNetCore.SignalR.Client` 10.0.2
  - Hub event dispatcher: `WebChat.Client/State/Hub/HubEventDispatcher.cs`
  - Connection dispatcher: `WebChat.Client/State/Hub/ConnectionEventDispatcher.cs`
- **Configuration**: KeepAlive 15s, ClientTimeout 5min
  - Source: `Agent/Modules/InjectorModule.cs:59-63`
- **Notifications**: `Infrastructure/Clients/Messaging/WebChat/HubNotifier.cs` -- implements `INotifier`
  - Adapter: `Agent/Hubs/HubNotificationAdapter.cs` -- implements `IHubNotificationSender`

### Azure Service Bus (inter-service messaging)
- **Client library**: `Azure.Messaging.ServiceBus` 7.20.1
  - Source: `Infrastructure/Infrastructure.csproj:25`
- **Wrapper**: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusChatMessengerClient.cs` -- implements `IChatMessengerClient`
  - Prompt receiver: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusPromptReceiver.cs`
  - Response writer: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusResponseWriter.cs`
  - Processor host: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusProcessorHost.cs` (IHostedService)
  - Message parser: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusMessageParser.cs`
- **Queues**: `prompt-queue` (inbound), `response-queue` (outbound)
  - Configured in `Agent/appsettings.json` section `"serviceBus"`
  - Settings: `Agent/Settings/ServiceBusSettings.cs`
- **Composite routing**: When Service Bus is enabled, `CompositeChatMessengerClient` routes messages to both WebChat and Service Bus
  - Source: `Infrastructure/Clients/Messaging/CompositeChatMessengerClient.cs`
- **Environment variable**: `SERVICEBUS__CONNECTIONSTRING`

### CLI Interface
- **Chat client**: `Infrastructure/Clients/Messaging/Cli/CliChatMessengerClient.cs` -- implements `IChatMessengerClient`
- **OneShot mode**: `Infrastructure/Clients/Messaging/Cli/OneShotChatMessengerClient.cs`
- **Command-line parser**: `Agent/Modules/ConfigModule.cs`
  - `--chat Cli|Telegram|Web|OneShot`
  - `--prompt|-p "text"` (triggers OneShot mode)
  - `--reasoning|-r` (show reasoning output)

## MCP Servers (Model Context Protocol)

All MCP servers use `ModelContextProtocol.AspNetCore` 0.8.0-preview.1 and expose tools at `/sse` endpoint.

### McpServerLibrary (torrent search & download management)
- **Port**: 6001 (container: 8080)
- **Entry**: `McpServerLibrary/Program.cs`
- **Tools**: `McpServerLibrary/McpTools/` -- file search, download, cleanup, move, status, recommendations
- **Depends on**: Jackett, qBittorrent, local file system
- **Config**: `McpServerLibrary/appsettings.json`

### McpServerText (file operations on vault)
- **Port**: 6002 (container: 8080)
- **Entry**: `McpServerText/Program.cs`
- **Tools**: `McpServerText/McpTools/` -- read, create, edit, search, glob, move, remove files
- **Volume**: `/vault` mounted from host
- **Config**: `McpServerText/appsettings.json`

### McpServerWebSearch (web search + browser automation)
- **Port**: 6003 (container: 8080)
- **Entry**: `McpServerWebSearch/Program.cs`
- **Tools**: `McpServerWebSearch/McpTools/` -- web search, browse, click, inspect
- **Depends on**: Brave Search API, Playwright/Chromium, CapSolver
- **Config**: `McpServerWebSearch/appsettings.json`

### McpServerMemory (semantic memory with vector search)
- **Port**: 6004 (container: 8080)
- **Entry**: `McpServerMemory/Program.cs`
- **Tools**: `McpServerMemory/McpTools/` -- store, recall, list, forget, reflect
- **Depends on**: Redis Stack (vector search), OpenRouter (embeddings)
- **Config**: `McpServerMemory/appsettings.json`

### McpServerIdealista (real estate search)
- **Port**: 6005 (container: 8080)
- **Entry**: `McpServerIdealista/Program.cs`
- **Tools**: `McpServerIdealista/McpTools/McpPropertySearchTool.cs`
- **Depends on**: Idealista API
- **Config**: `McpServerIdealista/appsettings.json`

### McpServerCommandRunner (shell command execution)
- **Entry**: `McpServerCommandRunner/Program.cs`
- **Tools**: `McpServerCommandRunner/McpTools/` -- run command, get CLI platform

## External APIs

### Brave Search API
- **Client**: `Infrastructure/Clients/BraveSearchClient.cs` -- implements `IWebSearchClient`
- **Base URL**: `https://api.search.brave.com/res/v1/`
  - Source: `McpServerWebSearch/appsettings.json:3`
- **Auth**: `X-Subscription-Token` header
- **Environment variable**: `BRAVESEARCH__APIKEY`

### Idealista API (real estate)
- **Client**: `Infrastructure/Clients/IdealistaClient.cs` -- implements `IIdealistaClient`
- **Base URL**: `https://api.idealista.com/`
  - Source: `McpServerIdealista/appsettings.json:3`
- **Auth**: OAuth2 client_credentials flow
  - Token endpoint: `oauth/token` with Basic auth (apiKey:apiSecret)
  - Tokens auto-refreshed 5 minutes before expiry
- **Environment variables**: `IDEALISTA__APIKEY`, `IDEALISTA__SECRET`

### CapSolver (CAPTCHA solving)
- **Client**: `Infrastructure/Clients/Browser/CapSolverClient.cs` -- implements `ICaptchaSolver`
- **API endpoint**: `https://api.capsolver.com/` (createTask / getTaskResult)
  - Source: `Infrastructure/Clients/Browser/CapSolverClient.cs:10-11`
- **Task type**: `DataDomeSliderTask`
- **Polling**: 3-second intervals, 2-minute max wait
- **Environment variable**: `CAPSOLVER__APIKEY`

### Jackett (torrent indexer aggregator)
- **Client**: `Infrastructure/Clients/Torrent/JackettSearchClient.cs` -- implements `ISearchClient`
- **Base URL**: `http://jackett:9117/api/v2.0/`
  - Source: `McpServerLibrary/appsettings.json:3`
- **Protocol**: Torznab XML API
- **Environment variable**: `JACKETT__APIKEY`

### qBittorrent (download client)
- **Client**: `Infrastructure/Clients/Torrent/QBittorrentDownloadClient.cs` -- implements `IDownloadClient`
- **Base URL**: `http://qbittorrent:8001/api/v2/`
  - Source: `McpServerLibrary/appsettings.json:7`
- **Auth**: Cookie-based (`SID`) via `auth/login`
- **Environment variables**: `QBITTORRENT__USERNAME`, `QBITTORRENT__PASSWORD`

## Media Services

### Plex Media Server
- **Role**: Media streaming, uses host network mode
- **Version**: 1.42.1
  - Source: `DockerCompose/docker-compose.yml:111`
- **Volume**: `${DATA_PATH}:/media` shared with McpServerLibrary

### FileBrowser
- **Role**: Web-based file management UI
- **Port**: 8002
  - Source: `DockerCompose/docker-compose.yml:55`
- **Volume**: `${DATA_PATH}:/srv`

## Networking / Infrastructure

### Caddy (reverse proxy)
- **Version**: Caddy 2
  - Source: `DockerCompose/docker-compose.yml:304`
- **Config**: `DockerCompose/Caddyfile`
- **Routes**:
  - `/hubs/*` -> `agent:8080` (SignalR)
  - `/*` -> `webui:8080` (Blazor frontend)
- **TLS**: Self-signed internal cert on port 443, plain HTTP on port 80 (for Cloudflare Tunnel)

### Cloudflare Tunnel
- **Image**: `cloudflare/cloudflared:latest`
  - Source: `DockerCompose/docker-compose.yml:324`
- **Purpose**: Expose services through Cloudflare without port forwarding
- **Environment variable**: `CLOUDFLARE_TUNNEL_TOKEN`

### DDNS IP Allowlist
- **Middleware**: `Infrastructure/Extensions/DdnsIpAllowlistExtensions.cs`
- **Purpose**: Restricts access to resolved IP of a dynamic DNS hostname
- **Environment variable**: `ALLOWEDDDNSHOST`

## Logging

- **Use**: Built-in `Microsoft.Extensions.Logging`
  - Default level: `Warning` for Agent, `Information` for MCP servers
  - Source: each project's `appsettings.json` `"Logging"` section
- **Pattern**: Inject `ILogger<T>` via constructor; do not use `Console.WriteLine`
- **HTTP client logging**: Suppressed to `Warning` level (`System.Net.Http.HttpClient`)

## Environment Variables Summary

| Variable | Service | Purpose |
|----------|---------|---------|
| `OPENROUTER__APIKEY` | Agent, MCP Memory | LLM and embedding API key |
| `JACK__TELEGRAM__BOTTOKEN` | Agent | Telegram bot token for Jack agent |
| `JONAS__TELEGRAM__BOTTOKEN` | Agent | Telegram bot token for Jonas agent |
| `TELEGRAM__ALLOWEDUSERNAMES__0..N` | Agent | Allowed Telegram usernames |
| `SERVICEBUS__CONNECTIONSTRING` | Agent | Azure Service Bus connection string |
| `BRAVESEARCH__APIKEY` | MCP WebSearch | Brave Search API key |
| `CAPSOLVER__APIKEY` | MCP WebSearch | CapSolver CAPTCHA service key |
| `JACKETT__APIKEY` | MCP Library | Jackett indexer API key |
| `QBITTORRENT__USERNAME` | MCP Library | qBittorrent login |
| `QBITTORRENT__PASSWORD` | MCP Library | qBittorrent password |
| `IDEALISTA__APIKEY` | MCP Idealista | Idealista OAuth client ID |
| `IDEALISTA__SECRET` | MCP Idealista | Idealista OAuth client secret |
| `REDISCONNECTIONSTRING` | MCP Memory | Redis connection string |
| `ALLOWEDDDNSHOST` | Agent, WebChat | DDNS hostname for IP allowlisting |
| `AGENTURL` | WebChat | Agent backend URL for SignalR |
| `CLOUDFLARE_TUNNEL_TOKEN` | Cloudflared | Tunnel authentication token |
| `USERS__0__ID`, `USERS__0__AVATARURL` | WebChat | WebChat user identity config |
| `DATA_PATH` | Docker Compose | Shared media/data volume path |
| `VAULT_PATH` | Docker Compose | Vault volume for MCP Text |
| `PUID`, `PGID` | Docker Compose | Unix user/group for file permissions |
