# External Integrations

> Auto-generated by /codemap-creator. Prescriptive guide for external service usage.

## LLM Provider

### OpenRouter (primary LLM API)
- **Client wrapper**: `Infrastructure/Agents/ChatClients/OpenRouterChatClient.cs` -- implements `IChatClient`
  - Use this wrapper, never use `OpenAI.OpenAIClient` directly
  - Handles reasoning content extraction from SSE streams
  - Prepends sender/timestamp metadata to user messages
  - Custom HTTP handler fixes empty assistant content with tool calls
- **HTTP helpers**: `Infrastructure/Agents/ChatClients/OpenRouterHttpHelpers.cs`
- **Configuration**: `Agent/appsettings.json` section `openRouter`
- **Environment variables**:
  - `OPENROUTER__APIKEY` -- API key for OpenRouter
- **Endpoint**: `https://openrouter.ai/api/v1/`
- **Models configured in**: `Agent/appsettings.json` section `agents[].model`
- **Embedding service**: `Infrastructure/Memory/OpenRouterEmbeddingService.cs` -- implements `IEmbeddingService`
  - Model: `openai/text-embedding-3-small` (configured in `McpServerMemory/appsettings.json`)
  - Vector dimension: 1536

## Databases / State Stores

### Redis / Redis Stack (primary data store)
- **Connection**: `Agent/Modules/InjectorModule.cs:83-84` -- `ConnectionMultiplexer.Connect()`
  - Package: `StackExchange.Redis` 2.10.14 (`Infrastructure/Infrastructure.csproj:37`)
  - Package: `NRedisStack` 1.2.0 (`Infrastructure/Infrastructure.csproj:31`) for vector search
- **Thread state store**: `Infrastructure/StateManagers/RedisThreadStateStore.cs` -- implements `IThreadStateStore`
  - Stores chat message history as JSON strings
  - Stores topic metadata with pattern `topic:{agentId}:{chatId}:{topicId}`
  - Default expiration: 30 days (configurable via `redis.expirationDays`)
- **Schedule store**: `Infrastructure/StateManagers/RedisScheduleStore.cs` -- implements `IScheduleStore`
  - Stores scheduled tasks with pattern `schedule:{id}`
  - Uses sorted sets for due-schedule lookups at `schedules:due`
- **Memory store** (vector search): `Infrastructure/Memory/RedisStackMemoryStore.cs` -- implements `IMemoryStore`
  - Uses RediSearch module (`FT.CREATE`, `FT.SEARCH`) for vector similarity
  - Index name: `idx:memories`, prefix: `memory:`
  - HNSW vector index with COSINE distance, 1536 dimensions
  - Profile storage at `memory:profile:{userId}`
  - Default expiry: 365 days
- **Chat history provider**: `Infrastructure/Agents/ChatClients/RedisChatMessageStore.cs` -- implements `ChatHistoryProvider`
  - Used by `McpAgent` for persisting conversation state
- **Environment variables**:
  - `Redis__ConnectionString` (Agent) -- defaults to `redis:6379`
  - `REDISCONNECTIONSTRING` (McpServerMemory) -- defaults to `localhost:6379`
- **Docker**: `redis/redis-stack-server:latest` at `DockerCompose/docker-compose.yml:3-16`
  - Port: 6379
  - Volume: `./volumes/redis_data:/data`

## Messaging

### Telegram Bot API
- **Client**: `Infrastructure/Clients/Messaging/Telegram/TelegramChatClient.cs` -- implements `IChatMessengerClient`
  - Package: `Telegram.Bot` 22.8.1 (`Infrastructure/Infrastructure.csproj:38`)
  - Supports multiple bots (one per agent)
  - Uses long-polling via `GetUpdates`
  - Creates forum topics for conversations
  - Authorization via allowlist of usernames
- **Bot helper**: `Infrastructure/Clients/Messaging/Telegram/TelegramBotHelper.cs`
- **Tool approval**: `Infrastructure/Clients/ToolApproval/TelegramToolApprovalHandler.cs`
- **DI registration**: `Agent/Modules/InjectorModule.cs:117-138`
- **Environment variables**:
  - `JACK__TELEGRAM__BOTTOKEN` -- Bot token for the "Jack" agent
  - `JONAS__TELEGRAM__BOTTOKEN` -- Bot token for the "Jonas" agent
  - `TELEGRAM__ALLOWEDUSERNAMES__0`, `TELEGRAM__ALLOWEDUSERNAMES__1` -- Authorized Telegram usernames

### Azure Service Bus
- **Client**: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusChatMessengerClient.cs` -- implements `IChatMessengerClient`
  - Package: `Azure.Messaging.ServiceBus` 7.20.1 (`Infrastructure/Infrastructure.csproj:25`)
  - Prompt receiver: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusPromptReceiver.cs`
  - Response handler: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusResponseHandler.cs`
  - Response writer: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusResponseWriter.cs`
  - Processor host: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusProcessorHost.cs` (hosted service)
  - Message parser: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusMessageParser.cs`
  - Source mapper: `Infrastructure/Clients/Messaging/ServiceBus/ServiceBusSourceMapper.cs`
- **Composite client**: `Infrastructure/Clients/Messaging/CompositeChatMessengerClient.cs` -- routes between WebChat and ServiceBus
- **Configuration**: `Agent/appsettings.json` section `serviceBus`
  - Queues: `prompt-queue` (inbound), `response-queue` (outbound)
  - Max concurrent calls: 10 (default)
- **Environment variables**:
  - `SERVICEBUS__CONNECTIONSTRING` -- Azure Service Bus connection string

### WebChat (SignalR)
- **Server hub**: `Agent/Hubs/ChatHub.cs` -- SignalR `Hub` subclass
  - Route: `/hubs/chat`
  - Methods: `RegisterUser`, `SendMessage`, `GetAgents`, `GetHistory`, `GetAllTopics`, `SaveTopic`, `DeleteTopic`, `StartSession`, `ResumeStream`, `CancelTopic`, `RespondToApprovalAsync`
- **Session management**: `Infrastructure/Clients/Messaging/WebChat/WebChatSessionManager.cs`
- **Stream management**: `Infrastructure/Clients/Messaging/WebChat/WebChatStreamManager.cs`
- **Approval management**: `Infrastructure/Clients/Messaging/WebChat/WebChatApprovalManager.cs`
- **Messenger client**: `Infrastructure/Clients/Messaging/WebChat/WebChatMessengerClient.cs` -- implements `IChatMessengerClient`
- **Hub notifier**: `Infrastructure/Clients/Messaging/WebChat/HubNotifier.cs` -- implements `INotifier`
- **Hub notification adapter**: `Agent/Hubs/HubNotificationAdapter.cs` -- implements `IHubNotificationSender`
- **Broadcast channel**: `Infrastructure/Clients/Messaging/WebChat/BroadcastChannel.cs`

## External APIs

### Brave Search API
- **Client wrapper**: `Infrastructure/Clients/BraveSearchClient.cs` -- implements `IWebSearchClient`
  - Use this wrapper via `IWebSearchClient`, never call the Brave API directly
  - Endpoint: `https://api.search.brave.com/res/v1/`
  - Auth: `X-Subscription-Token` header
- **Used by**: McpServerWebSearch (`McpServerWebSearch/McpTools/McpWebSearchTool.cs`)
- **Configuration**: `McpServerWebSearch/appsettings.json` section `BraveSearch`
- **Environment variables**:
  - `BRAVESEARCH__APIKEY` -- Brave Search subscription token

### Idealista API (real estate)
- **Client wrapper**: `Infrastructure/Clients/IdealistaClient.cs` -- implements `IIdealistaClient`
  - Use this wrapper via `IIdealistaClient`, never call the Idealista API directly
  - Endpoint: `https://api.idealista.com/`
  - Auth: OAuth2 client credentials (`Basic` auth for token, `Bearer` for API calls)
  - Token auto-refresh with 5-minute buffer
- **Used by**: McpServerIdealista (`McpServerIdealista/McpTools/McpPropertySearchTool.cs`)
- **Configuration**: `McpServerIdealista/appsettings.json` section `Idealista`
- **Environment variables**:
  - `IDEALISTA__APIKEY` -- OAuth client ID
  - `IDEALISTA__SECRET` -- OAuth client secret

### CapSolver API (CAPTCHA solving)
- **Client wrapper**: `Infrastructure/Clients/Browser/CapSolverClient.cs` -- implements `ICaptchaSolver`
  - Use this wrapper via `ICaptchaSolver`, never call CapSolver API directly
  - Endpoints: `https://api.capsolver.com/createTask`, `https://api.capsolver.com/getTaskResult`
  - Handles DataDome slider CAPTCHAs
  - Polls for solution with 3-second intervals, 2-minute timeout
- **Used by**: `PlaywrightWebBrowser` for automatic CAPTCHA solving during web browsing
- **Configuration**: `McpServerWebSearch/appsettings.json` section `CapSolver`
- **Environment variables**:
  - `CAPSOLVER__APIKEY` -- CapSolver API key

### Jackett (torrent indexer proxy)
- **Client wrapper**: `Infrastructure/Clients/Torrent/JackettSearchClient.cs` -- implements `ISearchClient`
  - Use this wrapper via `ISearchClient`, never call Jackett API directly
  - Endpoint: `http://jackett:9117/api/v2.0/`
  - Searches across all configured indexers via Torznab protocol
  - Results filtered to > 1 seeder, sorted by seeders, capped at 10
- **Used by**: McpServerLibrary (`McpServerLibrary/McpTools/McpFileDownloadTool.cs`)
- **Configuration**: `McpServerLibrary/appsettings.json` section `jackett`
- **Environment variables**:
  - `JACKETT__APIKEY` -- Jackett API key
- **Docker**: `lscr.io/linuxserver/jackett:0.24.306` at port 8003

### qBittorrent (torrent download client)
- **Client wrapper**: `Infrastructure/Clients/Torrent/QBittorrentDownloadClient.cs` -- implements `IDownloadClient`
  - Use this wrapper via `IDownloadClient`, never call qBittorrent API directly
  - Endpoint: `http://qbittorrent:8001/api/v2/`
  - Cookie-based authentication with auto-reauth on 403
  - Retry policy for download item polling
- **Used by**: McpServerLibrary
- **Configuration**: `McpServerLibrary/appsettings.json` section `qBitTorrent`
- **Environment variables**:
  - `QBITTORRENT__USERNAME` -- qBittorrent web UI username
  - `QBITTORRENT__PASSWORD` -- qBittorrent web UI password
- **Docker**: `qbittorrentofficial/qbittorrent-nox:5.1.2-2` at port 8001

## MCP Servers (internal microservices)

All MCP servers use `ModelContextProtocol.AspNetCore` 0.8.0-preview.1 and expose tools over HTTP/SSE on port 8080.

### McpServerLibrary
- **Tools**: `McpServerLibrary/McpTools/` -- file search, download, move, cleanup, glob, content recommendation, resubscribe downloads, get download status
- **Dependencies**: Jackett, qBittorrent, local file system
- **Port**: 6001 (external) -> 8080 (internal)

### McpServerText
- **Tools**: `McpServerText/McpTools/` -- text read, edit, create, glob, search, move, remove
- **Dependencies**: Local vault file system (configurable via `VaultPath`)
- **Port**: 6002 -> 8080

### McpServerWebSearch
- **Tools**: `McpServerWebSearch/McpTools/` -- web search, web browse, web click, web inspect
- **Dependencies**: Brave Search API, Playwright browser, CapSolver
- **Port**: 6003 -> 8080

### McpServerMemory
- **Tools**: `McpServerMemory/McpTools/` -- memory store, recall, list, reflect, forget
- **Dependencies**: Redis Stack (vector search), OpenRouter (embeddings)
- **Port**: 6004 -> 8080

### McpServerIdealista
- **Tools**: `McpServerIdealista/McpTools/` -- property search
- **Dependencies**: Idealista API
- **Port**: 6005 -> 8080

### McpServerCommandRunner
- **Tools**: `McpServerCommandRunner/McpTools/` -- run command, get CLI platform
- **Dependencies**: Local shell
- **No Docker port mapping in compose** (not deployed in production compose)

## Infrastructure Services (Docker)

### Plex Media Server
- **Docker**: `lscr.io/linuxserver/plex:1.42.1` at `DockerCompose/docker-compose.yml:110-128`
- **Network mode**: host
- **No direct code integration** -- media is shared via volume mounts with McpServerLibrary

### FileBrowser
- **Docker**: `filebrowser/filebrowser:v2` at `DockerCompose/docker-compose.yml:46-62`
- **Port**: 8002
- **No direct code integration** -- web UI for file management

### Caddy (reverse proxy / TLS)
- **Docker**: `caddy:2` at `DockerCompose/docker-compose.yml:304-321`
- **Port**: 443
- **Config**: `DockerCompose/Caddyfile`
- **Fronts**: webui (port 5001) and agent (port 5000)

### Cloudflare Tunnel
- **Docker**: `cloudflare/cloudflared:latest` at `DockerCompose/docker-compose.yml:324-336`
- **Environment variables**:
  - `CLOUDFLARE_TUNNEL_TOKEN` -- Tunnel authentication token

## Network & Security

### DDNS IP Allowlist
- **Middleware**: `Infrastructure/Extensions/DdnsIpAllowlistExtensions.cs`
  - Applied in `Agent/Program.cs:30` and `WebChat/Program.cs:9`
  - Restricts access to a configured DDNS hostname
- **Environment variables**:
  - `ALLOWEDDDNSHOST` -- DDNS hostname for IP allowlisting

## Environment Variables Summary

| Variable | Service | Purpose |
|----------|---------|---------|
| `OPENROUTER__APIKEY` | Agent, McpServerMemory | OpenRouter LLM API key |
| `JACK__TELEGRAM__BOTTOKEN` | Agent | Telegram bot token for Jack agent |
| `JONAS__TELEGRAM__BOTTOKEN` | Agent | Telegram bot token for Jonas agent |
| `TELEGRAM__ALLOWEDUSERNAMES__0..N` | Agent | Authorized Telegram usernames |
| `SERVICEBUS__CONNECTIONSTRING` | Agent | Azure Service Bus connection string |
| `BRAVESEARCH__APIKEY` | McpServerWebSearch | Brave Search API key |
| `CAPSOLVER__APIKEY` | McpServerWebSearch | CapSolver CAPTCHA API key |
| `IDEALISTA__APIKEY` | McpServerIdealista | Idealista OAuth client ID |
| `IDEALISTA__SECRET` | McpServerIdealista | Idealista OAuth client secret |
| `JACKETT__APIKEY` | McpServerLibrary | Jackett indexer API key |
| `QBITTORRENT__USERNAME` | McpServerLibrary | qBittorrent web UI username |
| `QBITTORRENT__PASSWORD` | McpServerLibrary | qBittorrent web UI password |
| `REDISCONNECTIONSTRING` | McpServerMemory | Redis connection string |
| `CLOUDFLARE_TUNNEL_TOKEN` | cloudflared | Cloudflare tunnel token |
| `ALLOWEDDDNSHOST` | Agent, WebChat | DDNS hostname for IP allowlist |
| `AGENTURL` | WebChat | Agent backend URL |
| `USERS__0__ID`, `USERS__0__AVATARURL` | WebChat | WebChat user identity config |
| `DATA_PATH` | Docker Compose | Shared data/media volume path |
| `VAULT_PATH` | Docker Compose | Vault directory for McpServerText |
| `REPOSITORY_PATH` | Docker Compose | Source repo path for Docker builds |
| `PUID`, `PGID` | Docker Compose | Unix user/group IDs for file permissions |
