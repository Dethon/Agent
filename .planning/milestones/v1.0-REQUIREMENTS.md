# Requirements Archive: v1.0 WebChat Stack Refactoring

**Archived:** 2026-01-20
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/PROJECT.md` (requirements section).

---

# Requirements: WebChat Stack Refactoring

**Defined:** 2026-01-19
**Core Value:** State flows in one direction - down from stores, up via events

## v1 Requirements

Requirements for the refactoring. Each maps to roadmap phases.

### State Foundation

- [x] **STATE-01**: Consolidated state stores replace scattered state across ChatStateManager, StreamingCoordinator, StreamResumeService
- [x] **STATE-02**: State represented as immutable C# record types with structural equality
- [x] **STATE-03**: Action -> Reducer -> State -> UI unidirectional flow pattern implemented
- [x] **STATE-04**: State selectors with memoization for derived state
- [x] **STATE-05**: StoreSubscriberComponent base class for components that subscribe to state

### State Slices

- [x] **SLICE-01**: TopicsState slice for topic list and selection (changes rarely)
- [x] **SLICE-02**: MessagesState slice for message history per topic
- [x] **SLICE-03**: StreamingState slice for active streaming with throttled updates
- [x] **SLICE-04**: ConnectionState slice for SignalR connection status
- [x] **SLICE-05**: ApprovalState slice for tool approval modal

### Streaming Performance

- [x] **PERF-01**: Selective re-rendering - streaming state notifications separate from topic state
- [x] **PERF-02**: Preserved 50ms throttled rendering to prevent UI freeze during streaming
- [x] **PERF-03**: Thread-safe state mutations - all state access wrapped in InvokeAsync

### SignalR Integration

- [x] **HUB-01**: HubEventDispatcher routes SignalR events to store actions
- [x] **HUB-02**: Reconnection preserves streaming state and resumes properly
- [x] **HUB-03**: Event subscription lifecycle properly managed (dispose on component disposal)

### Component Architecture

- [x] **COMP-01**: Components dispatch actions only, render from store state
- [x] **COMP-02**: ChatContainer.razor broken into smaller focused components
- [x] **COMP-03**: Components stay under 100 lines (render-focused, no business logic)

### Clean Architecture

- [x] **ARCH-01**: INotifier implementation moved from Agent/Hubs to Infrastructure
- [x] **ARCH-02**: State stores registered in proper layer (Infrastructure or WebChat.Client)
- [x] **ARCH-03**: No layer violations in refactored code

### Cleanup

- [x] **CLEAN-01**: ChatStateManager deleted (replaced by stores)
- [x] **CLEAN-02**: StreamingCoordinator deleted (logic moved to StreamingState + reducers)
- [x] **CLEAN-03**: All existing tests pass with equivalent or better coverage

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Fluxor library | Adds 300KB bundle size, overkill for chat domain |
| New WebChat features | This is refactoring, not feature work |
| Telegram/CLI changes | Different codepaths, not affected by this work |
| MCP server changes | Orthogonal concern |
| API signature changes | Must maintain backwards compatibility |

## Traceability

Which phases cover which requirements.

| Requirement | Phase | Status |
|-------------|-------|--------|
| STATE-01 | Phase 1 | Complete |
| STATE-02 | Phase 1 | Complete |
| STATE-03 | Phase 1 | Complete |
| STATE-04 | Phase 1 | Complete |
| STATE-05 | Phase 1 | Complete |
| SLICE-01 | Phase 2 | Complete |
| SLICE-02 | Phase 2 | Complete |
| SLICE-03 | Phase 2 | Complete |
| SLICE-04 | Phase 2 | Complete |
| SLICE-05 | Phase 2 | Complete |
| PERF-01 | Phase 3 | Complete |
| PERF-02 | Phase 3 | Complete |
| PERF-03 | Phase 3 | Complete |
| HUB-01 | Phase 4 | Complete |
| HUB-02 | Phase 4 | Complete |
| HUB-03 | Phase 4 | Complete |
| COMP-01 | Phase 5 | Complete |
| COMP-02 | Phase 5 | Complete |
| COMP-03 | Phase 5 | Complete |
| ARCH-01 | Phase 6 | Complete |
| ARCH-02 | Phase 6 | Complete |
| ARCH-03 | Phase 6 | Complete |
| CLEAN-01 | Phase 7 | Complete |
| CLEAN-02 | Phase 7 | Complete |
| CLEAN-03 | Phase 7 | Complete |

**Coverage:**
- v1 requirements: 25 total
- Mapped to phases: 25
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 25 of 25 v1 requirements
**Adjusted:** None (all requirements implemented as specified)
**Dropped:** None

---
*Archived: 2026-01-20 as part of v1.0 milestone completion*
