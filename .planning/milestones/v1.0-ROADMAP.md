# Milestone v1.0: WebChat Stack Refactoring

**Status:** SHIPPED 2026-01-20
**Phases:** 1-7
**Total Plans:** 24

## Overview

This roadmap transformed the WebChat stack from scattered bidirectional state management to a unidirectional Flux-inspired pattern. Phases were ordered by dependency: foundation infrastructure first, then state slices, then migration of existing code, then component simplification, and finally cleanup. Each phase delivered a coherent, verifiable capability that could be tested before proceeding.

## Phases

### Phase 1: State Foundation

**Goal:** Core state management infrastructure exists for unidirectional data flow.
**Depends on:** None (foundation phase)
**Plans:** 3 plans

Plans:
- [x] 01-01-PLAN.md - Core infrastructure (System.Reactive, IAction, Store)
- [x] 01-02-PLAN.md - Dispatch and subscription (IDispatcher, Dispatcher, StoreSubscriberComponent)
- [x] 01-03-PLAN.md - Memoized selectors (Selector<TState, TResult>)

**Requirements:**
- STATE-01: Consolidated state stores replace scattered state
- STATE-02: State represented as immutable C# record types
- STATE-03: Action -> Reducer -> State -> UI unidirectional flow pattern
- STATE-04: State selectors with memoization for derived state
- STATE-05: StoreSubscriberComponent base class for components

---

### Phase 2: State Slices

**Goal:** Feature-specific state slices exist with clear ownership boundaries.
**Depends on:** Phase 1 (State Foundation)
**Plans:** 3 plans

Plans:
- [x] 02-01-PLAN.md - Topics and Messages state slices (TopicsStore, MessagesStore)
- [x] 02-02-PLAN.md - Streaming and Connection state slices (StreamingStore, ConnectionStore)
- [x] 02-03-PLAN.md - Approval state slice and DI registration (ApprovalStore, Program.cs)

**Requirements:**
- SLICE-01: TopicsState slice for topic list and selection
- SLICE-02: MessagesState slice for message history per topic
- SLICE-03: StreamingState slice for active streaming with throttled updates
- SLICE-04: ConnectionState slice for SignalR connection status
- SLICE-05: ApprovalState slice for tool approval modal

---

### Phase 3: Streaming Performance

**Goal:** Streaming updates render efficiently without UI freezes.
**Depends on:** Phase 2 (State Slices)
**Plans:** 3 plans

Plans:
- [x] 03-01-PLAN.md - RenderCoordinator and throttled subscription infrastructure
- [x] 03-02-PLAN.md - CSS visual feedback (streaming cursor, typing indicator, error recovery)
- [x] 03-03-PLAN.md - Component wiring (MessageList with store integration)

**Requirements:**
- PERF-01: Selective re-rendering - streaming state notifications separate from topic state
- PERF-02: Preserved 50ms throttled rendering to prevent UI freeze
- PERF-03: Thread-safe state mutations - all state access wrapped in InvokeAsync

---

### Phase 4: SignalR Integration

**Goal:** SignalR events flow through the unidirectional pattern via HubEventDispatcher.
**Depends on:** Phase 3 (Streaming Performance)
**Plans:** 4 plans

Plans:
- [x] 04-01-PLAN.md - HubEventDispatcher (transforms SignalR notifications to store actions)
- [x] 04-02-PLAN.md - ConnectionEventDispatcher (connection lifecycle events to ConnectionStore)
- [x] 04-03-PLAN.md - ReconnectionEffect (stream resumption on reconnect)
- [x] 04-04-PLAN.md - Subscription lifecycle management (disposable tracking, duplicate prevention)

**Requirements:**
- HUB-01: HubEventDispatcher routes SignalR events to store actions
- HUB-02: Reconnection preserves streaming state and resumes properly
- HUB-03: Event subscription lifecycle properly managed

---

### Phase 5: Component Architecture

**Goal:** Components are thin render layers that dispatch actions and consume store state.
**Depends on:** Phase 4 (SignalR Integration)
**Plans:** 6 plans

Plans:
- [x] 05-01-PLAN.md - Leaf components (ConnectionStatus, ChatInput) migrate to stores
- [x] 05-02-PLAN.md - ApprovalModal migrates to store subscription
- [x] 05-03-PLAN.md - TopicList migrates to store subscriptions
- [x] 05-04-PLAN.md - Effect classes (SendMessageEffect, TopicSelectionEffect, TopicDeleteEffect)
- [x] 05-05-PLAN.md - ChatContainer simplification with InitializationEffect
- [x] 05-06-PLAN.md - MessageList migrates to store subscriptions

**Requirements:**
- COMP-01: Components dispatch actions only, render from store state
- COMP-02: ChatContainer.razor broken into smaller focused components
- COMP-03: Components stay under 100 lines

---

### Phase 6: Clean Architecture Alignment

**Goal:** All WebChat code respects Domain -> Infrastructure -> Agent layering.
**Depends on:** Phase 1 (can run partially in parallel with other phases)
**Plans:** 2 plans

Plans:
- [x] 06-01-PLAN.md - INotifier migration to Infrastructure layer
- [x] 06-02-PLAN.md - Store and effect registration consolidation

**Requirements:**
- ARCH-01: INotifier implementation moved from Agent/Hubs to Infrastructure
- ARCH-02: State stores registered in proper layer
- ARCH-03: No layer violations in refactored code

---

### Phase 7: Cleanup and Verification

**Goal:** Legacy code removed, full test coverage maintained, refactoring complete.
**Depends on:** Phase 5 (Component Architecture), Phase 6 (Clean Architecture)
**Plans:** 3 plans

Plans:
- [x] 07-01-PLAN.md - Delete ChatStateManager and migrate consumers to stores
- [x] 07-02-PLAN.md - Delete StreamingCoordinator, extract reusable logic
- [x] 07-03-PLAN.md - Dead code sweep and manual verification

**Requirements:**
- CLEAN-01: ChatStateManager deleted (replaced by stores)
- CLEAN-02: StreamingCoordinator deleted (logic moved to StreamingState + reducers)
- CLEAN-03: All existing tests pass with equivalent or better coverage

---

## Milestone Summary

**Key Decisions:**
- Custom stores over Fluxor (avoids 300KB bundle, maintains control)
- C# records for state (built-in immutability)
- BehaviorSubject for Store (replays to late subscribers)
- Sample over Throttle (fixed intervals for render ticks)
- Adapter pattern for INotifier (clean layer separation)
- Fire-and-forget effects (async work runs synchronously registered)
- Static BufferRebuildUtility (pure functions, no instance)

**Issues Resolved:**
- ChatContainer reduced from 305 to 28 lines
- StreamingCoordinator deleted (was 416 lines of mixed concerns)
- INotifier moved to proper layer (Infrastructure)
- All SignalR events now dispatch typed actions

**Issues Deferred:**
- Orphaned IChatNotificationHandler (can delete in future maintenance)
- 2 flaky tests in StreamResumeServiceTests (pre-existing)

**Technical Debt Incurred:**
- IChatNotificationHandler still registered in DI but never used

---

*For current project status, see .planning/PROJECT.md*
