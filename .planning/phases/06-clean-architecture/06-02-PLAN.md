---
phase: 06-clean-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - WebChat.Client/Extensions/ServiceCollectionExtensions.cs
  - WebChat.Client/Program.cs
autonomous: true

must_haves:
  truths:
    - "Store registration is consolidated into single extension method"
    - "Effect registration is consolidated into single extension method"
    - "Program.cs uses extension methods instead of inline registration"
    - "Stores only reference Domain/DTOs (no contracts, no services)"
  artifacts:
    - path: "WebChat.Client/Extensions/ServiceCollectionExtensions.cs"
      provides: "AddWebChatStores() and AddWebChatEffects() extension methods"
      exports: ["AddWebChatStores", "AddWebChatEffects"]
    - path: "WebChat.Client/Program.cs"
      provides: "Simplified service registration using extension methods"
      contains: "AddWebChatStores"
  key_links:
    - from: "Program.cs"
      to: "ServiceCollectionExtensions"
      via: "extension method call"
      pattern: "builder\\.Services\\.AddWebChatStores\\(\\)"
---

<objective>
Consolidate state store and effect registration into extension methods for cleaner architecture.

Purpose: The current Program.cs has scattered registration of stores and effects. Consolidating into extension methods improves organization, makes registration discoverable, and follows the established pattern in Agent/Modules/InjectorModule.cs.

Output: Clean Program.cs that calls `AddWebChatStores()` and `AddWebChatEffects()` extension methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-clean-architecture/06-CONTEXT.md

@WebChat.Client/Program.cs
@Agent/Modules/InjectorModule.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ServiceCollectionExtensions with store and effect registration</name>
  <files>WebChat.Client/Extensions/ServiceCollectionExtensions.cs</files>
  <action>
Create `ServiceCollectionExtensions.cs` in new `WebChat.Client/Extensions/` folder:

```csharp
using WebChat.Client.State;
using WebChat.Client.State.Topics;
using WebChat.Client.State.Messages;
using WebChat.Client.State.Streaming;
using WebChat.Client.State.Connection;
using WebChat.Client.State.Approval;
using WebChat.Client.State.Hub;
using WebChat.Client.State.Effects;

namespace WebChat.Client.Extensions;

public static class ServiceCollectionExtensions
{
    extension(IServiceCollection services)
    {
        public IServiceCollection AddWebChatStores()
        {
            // State infrastructure
            services.AddScoped<Dispatcher>();
            services.AddScoped<IDispatcher>(sp => sp.GetRequiredService<Dispatcher>());

            // Feature stores
            services.AddScoped<TopicsStore>();
            services.AddScoped<MessagesStore>();
            services.AddScoped<StreamingStore>();
            services.AddScoped<ConnectionStore>();
            services.AddScoped<ApprovalStore>();

            // State coordination
            services.AddScoped<RenderCoordinator>();

            return services;
        }

        public IServiceCollection AddWebChatEffects()
        {
            services.AddScoped<ReconnectionEffect>();
            services.AddScoped<SendMessageEffect>();
            services.AddScoped<TopicSelectionEffect>();
            services.AddScoped<TopicDeleteEffect>();
            services.AddScoped<InitializationEffect>();
            services.AddScoped<AgentSelectionEffect>();

            return services;
        }
    }
}
```

Use extension method syntax (C# 14 `extension` keyword) to match the pattern in InjectorModule.cs.

Note: Effects are registered but not activated here - activation happens in Program.cs after Build() to ensure all dependencies are available.
  </action>
  <verify>
    - File exists: `test -f WebChat.Client/Extensions/ServiceCollectionExtensions.cs`
    - `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds
  </verify>
  <done>
    - ServiceCollectionExtensions.cs exists in WebChat.Client/Extensions/
    - AddWebChatStores() method defined
    - AddWebChatEffects() method defined
    - WebChat.Client project compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Program.cs to use extension methods</name>
  <files>WebChat.Client/Program.cs</files>
  <action>
Update Program.cs to use the new extension methods:

1. Add using statement: `using WebChat.Client.Extensions;`

2. Replace scattered store registration (lines ~43-55) with:
   `builder.Services.AddWebChatStores();`

3. Replace scattered effect registration (lines ~57-62) with:
   `builder.Services.AddWebChatEffects();`

4. Keep effect activation after Build() unchanged (this is necessary):
   ```csharp
   // Activate effects that need to run at startup
   _ = app.Services.GetRequiredService<ReconnectionEffect>();
   _ = app.Services.GetRequiredService<SendMessageEffect>();
   // ... etc
   ```

5. Remove the individual using statements that are now in the extension class:
   - `using WebChat.Client.State;`
   - `using WebChat.Client.State.Topics;`
   - `using WebChat.Client.State.Messages;`
   - `using WebChat.Client.State.Streaming;`
   - `using WebChat.Client.State.Connection;`
   - `using WebChat.Client.State.Approval;`
   - `using WebChat.Client.State.Hub;`
   - `using WebChat.Client.State.Effects;`

   Note: Keep the using statements that are still needed for effect activation after Build().

The result should be a cleaner Program.cs with clear sections:
- Basic setup (HttpClient, etc.)
- Hub event dispatching
- Connection services
- Core services
- State management (legacy, to be removed in Phase 7)
- **State stores**: `builder.Services.AddWebChatStores();`
- **State effects**: `builder.Services.AddWebChatEffects();`
- Streaming services (legacy, to be removed in Phase 7)
- Notification handling
  </action>
  <verify>
    - `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds
    - `grep "AddWebChatStores" WebChat.Client/Program.cs` finds the call
    - `grep "AddWebChatEffects" WebChat.Client/Program.cs` finds the call
    - No inline store registration: `grep "AddScoped<TopicsStore>" WebChat.Client/Program.cs` returns empty
  </verify>
  <done>
    - Program.cs uses AddWebChatStores() extension method
    - Program.cs uses AddWebChatEffects() extension method
    - Inline store/effect registration removed from Program.cs
    - Application still runs correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify store layer compliance and audit store dependencies</name>
  <files>None (verification only)</files>
  <action>
1. Verify stores only reference Domain/DTOs (acceptable) and not Domain/Contracts or Domain services:
   ```bash
   # Check for Domain contract references (should be empty except for DTOs)
   grep -r "using Domain\.Contracts" WebChat.Client/State/ --include="*.cs"
   grep -r "using Domain\.Agents" WebChat.Client/State/ --include="*.cs"
   grep -r "using Domain\.Tools" WebChat.Client/State/ --include="*.cs"
   ```

   Expected: Only `using Domain.DTOs` or `using Domain.DTOs.WebChat` should appear.

2. Verify no Infrastructure references from WebChat.Client:
   ```bash
   grep -r "using Infrastructure" WebChat.Client/ --include="*.cs"
   ```
   Expected: Empty result.

3. Verify no Agent references from WebChat.Client:
   ```bash
   grep -r "using Agent" WebChat.Client/ --include="*.cs"
   ```
   Expected: Empty result.

4. Run the application to verify startup:
   - `dotnet run --project Agent/Agent.csproj -- --interface web`
   - Verify no DI errors at startup
   - Ctrl+C to stop

5. Run full test suite:
   - `dotnet test`
   - All tests should pass

Rationale: This confirms ARCH-02 (stores in proper layer) and ARCH-03 (no layer violations).
  </action>
  <verify>
    - `grep -r "using Domain\.Contracts" WebChat.Client/State/` returns empty
    - `grep -r "using Infrastructure" WebChat.Client/` returns empty
    - `grep -r "using Agent" WebChat.Client/` returns empty
    - `dotnet test` passes all tests
  </verify>
  <done>
    - Stores only reference Domain/DTOs (layer compliant)
    - No Infrastructure references from WebChat.Client
    - No Agent references from WebChat.Client
    - All tests pass
    - ARCH-02 and ARCH-03 requirements satisfied
  </done>
</task>

</tasks>

<verification>
1. Build verification: `dotnet build` succeeds for entire solution
2. Extension methods exist: ServiceCollectionExtensions.cs in WebChat.Client/Extensions/
3. Program.cs simplified: Uses AddWebChatStores() and AddWebChatEffects()
4. Layer compliance:
   - Stores only use Domain/DTOs
   - No Infrastructure/Agent references from WebChat.Client
5. Test verification: `dotnet test` passes all tests
</verification>

<success_criteria>
- ServiceCollectionExtensions.cs exists with AddWebChatStores() and AddWebChatEffects()
- Program.cs uses extension methods for store and effect registration
- No inline store/effect registration in Program.cs
- Stores only reference Domain/DTOs (verified by grep)
- No layer violations in WebChat.Client
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-clean-architecture/06-02-SUMMARY.md`
</output>
