---
phase: 10-backend-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Domain/DTOs/WebChat/ChatHistoryMessage.cs
  - Domain/Monitor/ChatMonitor.cs
  - Agent/Hubs/ChatHub.cs
  - WebChat.Client/State/Effects/TopicSelectionEffect.cs
  - WebChat.Client/State/Effects/InitializationEffect.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Loaded history messages show sender username"
    - "Loaded history messages show sender avatar"
    - "Loaded history shows correct sender after page refresh"
  artifacts:
    - path: "Domain/DTOs/WebChat/ChatHistoryMessage.cs"
      provides: "Sender fields in history DTO"
      contains: "SenderId"
    - path: "Domain/Monitor/ChatMonitor.cs"
      provides: "Sender metadata in stored messages"
      pattern: "AdditionalProperties"
    - path: "Agent/Hubs/ChatHub.cs"
      provides: "Sender extraction from stored messages"
      pattern: "AdditionalProperties"
  key_links:
    - from: "Domain/Monitor/ChatMonitor.cs"
      to: "ChatMessage.AdditionalProperties"
      via: "Store sender in message metadata"
      pattern: "AdditionalProperties.*Sender"
    - from: "Agent/Hubs/ChatHub.cs"
      to: "ChatHistoryMessage"
      via: "Extract sender from AdditionalProperties"
      pattern: "GetValueOrDefault"
---

<objective>
Fix history sender attribution so loaded messages display the correct sender username and avatar after page refresh.

Purpose: UAT Test 4 failed - loaded history shows "?" for sender instead of actual sender identity. This gap closure ensures sender metadata is persisted with messages and returned when history is loaded.

Output: Users see correct sender attribution on all messages, including those loaded from history after refresh.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/chat-history-sender-attribution.md

# Key files for this gap closure
@Domain/DTOs/WebChat/ChatHistoryMessage.cs
@Domain/Monitor/ChatMonitor.cs
@Agent/Hubs/ChatHub.cs
@WebChat.Client/State/Effects/TopicSelectionEffect.cs
@WebChat.Client/State/Effects/InitializationEffect.cs

# Related context
@WebChat.Client/Models/ChatMessageModel.cs
@Infrastructure/Agents/ChatClients/RedisChatMessageStore.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sender fields to ChatHistoryMessage and store sender in messages</name>
  <files>
    Domain/DTOs/WebChat/ChatHistoryMessage.cs
    Domain/Monitor/ChatMonitor.cs
  </files>
  <action>
1. Update ChatHistoryMessage record to include sender fields:
   - Add `string? SenderId` parameter
   - Add `string? SenderUsername` parameter
   - Add `string? SenderAvatarUrl` parameter
   - Keep existing Role and Content as first two parameters

2. Modify ChatMonitor.ProcessChatThread to store sender metadata in ChatMessage:
   - The ChatPrompt `x` has `x.Sender` (username string)
   - Instead of calling `agent.RunStreamingAsync(x.Prompt, thread, ...)` with just the string:
   - Create a ChatMessage with:
     - Role: ChatRole.User
     - Content: x.Prompt (as TextContent)
     - AdditionalProperties with keys: "SenderId" (use x.Sender as ID since that's what we have), "SenderUsername" (x.Sender)
   - Call `agent.RunStreamingAsync([userMessage], thread, ...)` with the ChatMessage array
   - Note: AvatarUrl cannot be determined here (Domain layer has no user lookup). Leave it null - client will use fallback.

Key implementation detail for ChatMonitor change:
```csharp
var userMessage = new ChatMessage(ChatRole.User, x.Prompt)
{
    AdditionalProperties = new AdditionalPropertiesDictionary
    {
        ["SenderId"] = x.Sender,
        ["SenderUsername"] = x.Sender
    }
};
return agent
    .RunStreamingAsync([userMessage], thread, cancellationToken: linkedCt)
    // ... rest unchanged
```
  </action>
  <verify>
    - `dotnet build Domain` succeeds
    - ChatHistoryMessage has 5 parameters: Role, Content, SenderId, SenderUsername, SenderAvatarUrl
    - ChatMonitor creates ChatMessage with AdditionalProperties containing sender keys
  </verify>
  <done>
    - ChatHistoryMessage DTO includes sender fields
    - User messages stored with sender metadata in AdditionalProperties
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract sender from stored messages in GetHistory</name>
  <files>
    Agent/Hubs/ChatHub.cs
  </files>
  <action>
Update GetHistory method to extract sender info from ChatMessage.AdditionalProperties:

1. When iterating over messages, for each ChatMessage `m`:
   - Extract SenderId: `m.AdditionalProperties?.GetValueOrDefault("SenderId") as string`
   - Extract SenderUsername: `m.AdditionalProperties?.GetValueOrDefault("SenderUsername") as string`
   - Extract SenderAvatarUrl: `m.AdditionalProperties?.GetValueOrDefault("SenderAvatarUrl") as string`

2. Create ChatHistoryMessage with all 5 parameters:
   ```csharp
   new ChatHistoryMessage(
       m.Role.Value,
       string.Join("", m.Contents.OfType<TextContent>().Select(c => c.Text)),
       m.AdditionalProperties?.GetValueOrDefault("SenderId") as string,
       m.AdditionalProperties?.GetValueOrDefault("SenderUsername") as string,
       m.AdditionalProperties?.GetValueOrDefault("SenderAvatarUrl") as string)
   ```

3. Keep the existing filters (Role check, non-empty content).
  </action>
  <verify>
    - `dotnet build Agent` succeeds
    - GetHistory returns ChatHistoryMessage with sender fields populated for user messages
  </verify>
  <done>
    - GetHistory extracts sender metadata from stored ChatMessage.AdditionalProperties
    - ChatHistoryMessage includes sender info when available
  </done>
</task>

<task type="auto">
  <name>Task 3: Map sender fields in client history loading</name>
  <files>
    WebChat.Client/State/Effects/TopicSelectionEffect.cs
    WebChat.Client/State/Effects/InitializationEffect.cs
  </files>
  <action>
Update both effects to map sender fields when creating ChatMessageModel from ChatHistoryMessage:

1. In TopicSelectionEffect.HandleSelectTopicAsync (around line 64-68):
   Change:
   ```csharp
   var messages = history.Select(h => new ChatMessageModel
   {
       Role = h.Role,
       Content = h.Content
   }).ToList();
   ```
   To:
   ```csharp
   var messages = history.Select(h => new ChatMessageModel
   {
       Role = h.Role,
       Content = h.Content,
       SenderId = h.SenderId,
       SenderUsername = h.SenderUsername,
       SenderAvatarUrl = h.SenderAvatarUrl
   }).ToList();
   ```

2. In InitializationEffect.LoadTopicHistoryAsync (around line 101-105):
   Apply the same change - add SenderId, SenderUsername, SenderAvatarUrl to the ChatMessageModel initializer.
  </action>
  <verify>
    - `dotnet build WebChat.Client` succeeds
    - Both effects map all 5 fields from ChatHistoryMessage to ChatMessageModel
  </verify>
  <done>
    - TopicSelectionEffect maps sender fields when loading history
    - InitializationEffect maps sender fields when loading history
    - Loaded history messages have correct sender attribution
  </done>
</task>

</tasks>

<verification>
1. Full solution build: `dotnet build Agent.sln`
2. Run tests: `dotnet test Agent.sln`
3. Manual verification:
   - Start app with `docker compose up`
   - Select user (e.g., Alice)
   - Send a message
   - Refresh page (F5)
   - Verify loaded message shows "Alice" username and avatar (not "?")
</verification>

<success_criteria>
- Loaded history messages display sender's username on hover
- Loaded history messages display sender's avatar (or fallback initials)
- Page refresh preserves sender attribution for all previously sent messages
- New messages continue to work as before
- UAT Test 4 passes: "Identity After Page Refresh"
</success_criteria>

<output>
After completion, create `.planning/phases/10-backend-integration/10-03-SUMMARY.md`
</output>
