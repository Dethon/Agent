---
phase: 07-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - WebChat.Client/Services/State/ChatStateManager.cs
  - WebChat.Client/Contracts/IChatStateManager.cs
  - WebChat.Client/Program.cs
  - WebChat.Client/Services/Handlers/ChatNotificationHandler.cs
  - WebChat.Client/Services/Streaming/StreamResumeService.cs
  - Tests/Unit/WebChat/Client/ChatStateManagerTests.cs
  - Tests/Unit/WebChat/Client/StreamResumeServiceTests.cs
  - Tests/Unit/WebChat/Client/ChatNotificationHandlerTests.cs
autonomous: true

must_haves:
  truths:
    - "ChatStateManager.cs file no longer exists in codebase"
    - "IChatStateManager.cs interface file no longer exists in codebase"
    - "All compilation errors resolved after deletion"
    - "ChatNotificationHandler uses stores instead of IChatStateManager"
    - "StreamResumeService uses stores instead of IChatStateManager"
    - "All tests pass (except pre-existing StreamResumeService failures deferred to Plan 02)"
  artifacts:
    - path: "WebChat.Client/Services/Handlers/ChatNotificationHandler.cs"
      provides: "Notification handling via stores"
      contains: "IDispatcher"
    - path: "WebChat.Client/Services/Streaming/StreamResumeService.cs"
      provides: "Stream resume via stores"
      contains: "TopicsStore|MessagesStore"
    - path: "WebChat.Client/Program.cs"
      provides: "DI without IChatStateManager"
      not_contains: "IChatStateManager"
  key_links:
    - from: "ChatNotificationHandler"
      to: "TopicsStore/MessagesStore"
      via: "IDispatcher.Dispatch()"
      pattern: "_dispatcher\\.Dispatch"
    - from: "StreamResumeService"
      to: "TopicsStore/MessagesStore"
      via: "Store subscriptions"
      pattern: "topicsStore|messagesStore"
---

<objective>
Delete ChatStateManager and IChatStateManager, migrating all consumers to use the store-based architecture.

Purpose: ChatStateManager was the centralized mutable state manager that has been replaced by TopicsStore, MessagesStore, StreamingStore, and ApprovalStore. Removing it completes the transition to unidirectional data flow.

Output: Codebase compiles without ChatStateManager, all consumers use stores via IDispatcher.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-verification/07-RESEARCH.md
@.planning/phases/07-cleanup-verification/07-CONTEXT.md
@WebChat.Client/Services/State/ChatStateManager.cs
@WebChat.Client/Contracts/IChatStateManager.cs
@WebChat.Client/Program.cs
@WebChat.Client/Services/Handlers/ChatNotificationHandler.cs
@WebChat.Client/Services/Streaming/StreamResumeService.cs
@WebChat.Client/State/Topics/TopicsStore.cs
@WebChat.Client/State/Messages/MessagesStore.cs
@WebChat.Client/State/Streaming/StreamingStore.cs
@WebChat.Client/State/Approval/ApprovalStore.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete ChatStateManager and migrate ChatNotificationHandler</name>
  <files>
    WebChat.Client/Services/State/ChatStateManager.cs
    WebChat.Client/Contracts/IChatStateManager.cs
    WebChat.Client/Program.cs
    WebChat.Client/Services/Handlers/ChatNotificationHandler.cs
  </files>
  <action>
1. Delete `WebChat.Client/Services/State/ChatStateManager.cs`
2. Delete `WebChat.Client/Contracts/IChatStateManager.cs`
3. Update `WebChat.Client/Program.cs`:
   - Remove the line: `builder.Services.AddScoped<IChatStateManager, ChatStateManager>();`
   - Remove unused `using WebChat.Client.Services.State;` if no other references

4. Update `WebChat.Client/Services/Handlers/ChatNotificationHandler.cs`:
   - Replace IChatStateManager dependency with: IDispatcher, TopicsStore, MessagesStore, StreamingStore, ApprovalStore
   - Migrate each method:

   HandleTopicChangedAsync:
   - `stateManager.Topics` -> `_topicsStore.State.Topics`
   - `stateManager.AddTopic(topic)` -> `_dispatcher.Dispatch(new AddTopic(topic))`
   - `stateManager.UpdateTopic(metadata)` -> `_dispatcher.Dispatch(new UpdateTopic(metadata))`
   - `stateManager.RemoveTopic(topicId)` -> `_dispatcher.Dispatch(new RemoveTopic(topicId))`

   HandleStreamChangedAsync:
   - `stateManager.GetTopicById(topicId)` -> `_topicsStore.State.Topics.FirstOrDefault(t => t.TopicId == topicId)`
   - `stateManager.IsTopicResuming(topicId)` -> `_streamingStore.State.ResumingTopics.Contains(topicId)`
   - `stateManager.StopStreaming(topicId)` -> `_dispatcher.Dispatch(new StreamCompleted(topicId))`

   HandleNewMessageAsync:
   - `stateManager.GetTopicById(topicId)` -> `_topicsStore.State.Topics.FirstOrDefault(...)`
   - `stateManager.IsTopicStreaming(topicId)` -> `_streamingStore.State.StreamingTopics.Contains(topicId)`
   - `stateManager.SetMessagesForTopic(topicId, messages)` -> `_dispatcher.Dispatch(new MessagesLoaded(topicId, messages))`

   HandleApprovalResolvedAsync:
   - `stateManager.CurrentApprovalRequest` -> `_approvalStore.State.Request`
   - `stateManager.SetApprovalRequest(null)` -> `_dispatcher.Dispatch(new HideApproval())`
   - `stateManager.AddToolCallsToStreamingMessage(topicId, toolCalls)` -> `_dispatcher.Dispatch(new StreamChunk(topicId, null, null, toolCalls, null))`

   HandleToolCallsAsync:
   - Same as above for AddToolCallsToStreamingMessage

5. Add required imports to ChatNotificationHandler:
   - `using WebChat.Client.State;`
   - `using WebChat.Client.State.Topics;`
   - `using WebChat.Client.State.Messages;`
   - `using WebChat.Client.State.Streaming;`
   - `using WebChat.Client.State.Approval;`

6. Build to verify compilation succeeds.
  </action>
  <verify>
    `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds with no errors
  </verify>
  <done>
    - ChatStateManager.cs deleted
    - IChatStateManager.cs deleted
    - ChatNotificationHandler compiles using stores
    - Program.cs has no IChatStateManager registration
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate StreamResumeService from IChatStateManager</name>
  <files>
    WebChat.Client/Services/Streaming/StreamResumeService.cs
  </files>
  <action>
1. Update StreamResumeService constructor:
   - Remove IChatStateManager parameter
   - Add TopicsStore and MessagesStore parameters (StreamingStore already present)

2. Migrate each IChatStateManager usage:

   Guard checks:
   - `stateManager.HasMessagesForTopic(topicId)` -> `_messagesStore.State.MessagesByTopic.ContainsKey(topicId)`

   Loading history:
   - `dispatcher.Dispatch(new MessagesLoaded(...))` is already correct

   Getting existing messages (line ~63):
   - `stateManager.GetMessagesForTopic(topicId)` -> `_messagesStore.State.MessagesByTopic.GetValueOrDefault(topicId) ?? []`
   - Note: This returns IReadOnlyList, but code adds to it. Need to dispatch AddMessage actions instead.

   Adding prompt message (line ~72):
   - `existingMessages.Add(new ChatMessageModel {...})` -> `_dispatcher.Dispatch(new AddMessage(topicId, new ChatMessageModel {...}))`

   Adding completed turns (line ~94):
   - `existingMessages.AddRange(completedTurns)` -> For each turn: `_dispatcher.Dispatch(new AddMessage(topicId, turn))`

3. The key insight: StreamResumeService currently mutates messages lists directly. After migration, it must dispatch actions for all message additions.

4. Update imports:
   - Remove `using WebChat.Client.Services.State;` if unused
   - Add `using WebChat.Client.State.Messages;`
   - Add `using WebChat.Client.State.Topics;`

5. Build to verify compilation succeeds.
  </action>
  <verify>
    `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds with no errors
  </verify>
  <done>
    - StreamResumeService has no IChatStateManager dependency
    - All message operations use dispatcher and stores
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix and migrate ChatStateManager-related tests</name>
  <files>
    Tests/Unit/WebChat/Client/ChatStateManagerTests.cs
    Tests/Unit/WebChat/Client/StreamResumeServiceTests.cs
    Tests/Unit/WebChat/Client/ChatNotificationHandlerTests.cs
    Tests/Integration/WebChat/Client/StreamResumeServiceIntegrationTests.cs
  </files>
  <action>
1. DELETE `Tests/Unit/WebChat/Client/ChatStateManagerTests.cs` entirely.
   Reason: All state mutation tests are obsolete. Store tests in Tests/Unit/WebChat.Client/State/ cover equivalent behavior.

2. UPDATE `Tests/Unit/WebChat/Client/StreamResumeServiceTests.cs`:
   - Remove ChatStateManager from test setup
   - Add TopicsStore and MessagesStore to test setup
   - For each test that reads from stateManager, read from store instead:
     - `_stateManager.GetMessagesForTopic(topicId)` -> `_messagesStore.State.MessagesByTopic.GetValueOrDefault(topicId)`
     - `_stateManager.IsTopicStreaming(topicId)` -> `_streamingStore.State.StreamingTopics.Contains(topicId)`
     - `_stateManager.IsTopicResuming(topicId)` -> `_streamingStore.State.ResumingTopics.Contains(topicId)`
   - For test setup that calls stateManager methods, dispatch actions instead:
     - `_stateManager.AddTopic(topic)` -> `_dispatcher.Dispatch(new AddTopic(topic))`
     - `_stateManager.SetMessagesForTopic(...)` -> `_dispatcher.Dispatch(new MessagesLoaded(...))`
     - `_stateManager.StartStreaming(topicId)` -> `_dispatcher.Dispatch(new StreamStarted(topicId))`
     - `_stateManager.TryStartResuming(topicId)` -> `_dispatcher.Dispatch(new StartResuming(topicId))`
   - Fix the 2 pre-existing test failures (TryResumeStreamAsync_LoadsHistoryIfNeeded, TryResumeStreamAsync_StartsStreaming):
     - Root cause: Tests read from ChatStateManager but service dispatches to stores
     - Fix: Read from MessagesStore and StreamingStore instead of ChatStateManager

3. UPDATE `Tests/Unit/WebChat/Client/ChatNotificationHandlerTests.cs`:
   - Replace IChatStateManager mock with real stores + dispatcher
   - Verify actions are dispatched instead of verifying stateManager calls

4. UPDATE `Tests/Integration/WebChat/Client/StreamResumeServiceIntegrationTests.cs`:
   - Same pattern: replace ChatStateManager with stores
   - Ensure all assertions read from stores

5. Run all tests to verify.
  </action>
  <verify>
    `dotnet test Tests/Tests.csproj --filter "FullyQualifiedName~WebChat.Client" --no-build` all pass
  </verify>
  <done>
    - ChatStateManagerTests.cs deleted
    - StreamResumeServiceTests all pass (including previously failing tests)
    - ChatNotificationHandlerTests all pass with store-based verification
    - Integration tests pass
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build Agent.sln`
2. Run WebChat.Client unit tests: `dotnet test Tests/Tests.csproj --filter "FullyQualifiedName~WebChat.Client"`
3. Grep confirms no ChatStateManager references: `grep -r "ChatStateManager\|IChatStateManager" --include="*.cs" WebChat.Client/`
4. Grep confirms no ChatStateManager references in non-deleted tests: `grep -r "ChatStateManager" --include="*.cs" Tests/`
</verification>

<success_criteria>
1. ChatStateManager.cs and IChatStateManager.cs deleted from codebase
2. No compilation errors in WebChat.Client project
3. All WebChat.Client tests pass (no failures)
4. ChatNotificationHandler uses stores via IDispatcher
5. StreamResumeService uses stores via IDispatcher (still uses IStreamingCoordinator - migrated in Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-01-SUMMARY.md`
</output>
