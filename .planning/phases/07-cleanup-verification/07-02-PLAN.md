---
phase: 07-cleanup-verification
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - WebChat.Client/Services/Streaming/StreamingCoordinator.cs
  - WebChat.Client/Contracts/IStreamingCoordinator.cs
  - WebChat.Client/Program.cs
  - WebChat.Client/State/Effects/SendMessageEffect.cs
  - WebChat.Client/Services/Streaming/StreamResumeService.cs
  - Tests/Unit/WebChat/Client/StreamingCoordinatorTests.cs
  - Tests/Integration/WebChat/Client/StreamingCoordinatorIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "StreamingCoordinator.cs file no longer exists in codebase"
    - "IStreamingCoordinator.cs interface file no longer exists in codebase"
    - "All compilation errors resolved after deletion"
    - "RebuildFromBuffer and StripKnownContent logic preserved for reconnection"
    - "SendMessageEffect handles streaming without IStreamingCoordinator"
    - "All tests pass"
  artifacts:
    - path: "WebChat.Client/Services/Streaming/StreamingService.cs"
      provides: "Streaming logic extracted from coordinator"
      exports: ["StreamResponseAsync", "ResumeStreamResponseAsync"]
    - path: "WebChat.Client/Services/Streaming/BufferRebuildUtility.cs"
      provides: "Pure functions for buffer rebuild"
      exports: ["RebuildFromBuffer", "StripKnownContent"]
    - path: "WebChat.Client/Program.cs"
      provides: "DI without IStreamingCoordinator"
      not_contains: "IStreamingCoordinator"
  key_links:
    - from: "SendMessageEffect"
      to: "IStreamingService"
      via: "StreamResponseAsync"
      pattern: "_streamingService\\.StreamResponseAsync"
    - from: "StreamResumeService"
      to: "BufferRebuildUtility"
      via: "Static method call"
      pattern: "BufferRebuildUtility\\.(RebuildFromBuffer|StripKnownContent)"
---

<objective>
Delete StreamingCoordinator and IStreamingCoordinator, extracting reusable logic to focused services.

Purpose: StreamingCoordinator combined streaming orchestration with buffer rebuild logic. The streaming is now handled via store actions; the buffer rebuild logic is pure and should be extracted for StreamResumeService.

Output: Codebase compiles without StreamingCoordinator, streaming uses stores, buffer rebuild logic preserved in utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-verification/07-RESEARCH.md
@.planning/phases/07-cleanup-verification/07-CONTEXT.md
@.planning/phases/07-cleanup-verification/07-01-SUMMARY.md
@WebChat.Client/Services/Streaming/StreamingCoordinator.cs
@WebChat.Client/Contracts/IStreamingCoordinator.cs
@WebChat.Client/State/Effects/SendMessageEffect.cs
@WebChat.Client/Services/Streaming/StreamResumeService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract BufferRebuildUtility and create IStreamingService</name>
  <files>
    WebChat.Client/Services/Streaming/BufferRebuildUtility.cs
    WebChat.Client/Services/Streaming/StreamingService.cs
    WebChat.Client/Contracts/IStreamingService.cs
  </files>
  <action>
1. CREATE `WebChat.Client/Services/Streaming/BufferRebuildUtility.cs`:
   - Static class with pure functions extracted from StreamingCoordinator
   - Extract `RebuildFromBuffer` method (lines 215-277 of StreamingCoordinator)
   - Extract `StripKnownContent` method (lines 279-302 of StreamingCoordinator)
   - Extract `AccumulateChunk` helper (lines 304-341 of StreamingCoordinator)
   - All methods are static, no dependencies, fully testable

```csharp
namespace WebChat.Client.Services.Streaming;

public static class BufferRebuildUtility
{
    public static (List<ChatMessageModel> CompletedTurns, ChatMessageModel StreamingMessage) RebuildFromBuffer(
        IReadOnlyList<ChatStreamMessage> bufferedMessages,
        HashSet<string> historyContent)
    {
        // ... extracted logic
    }

    public static ChatMessageModel StripKnownContent(ChatMessageModel message, HashSet<string> historyContent)
    {
        // ... extracted logic
    }

    internal static ChatMessageModel AccumulateChunk(
        ChatMessageModel streamingMessage,
        ChatStreamMessage chunk,
        ref bool needsReasoningSeparator)
    {
        // ... extracted logic
    }
}
```

2. CREATE `WebChat.Client/Contracts/IStreamingService.cs`:
   - Interface for streaming operations
   - Methods: `StreamResponseAsync`, `ResumeStreamResponseAsync`

```csharp
namespace WebChat.Client.Contracts;

public interface IStreamingService
{
    Task StreamResponseAsync(StoredTopic topic, string message);
    Task ResumeStreamResponseAsync(StoredTopic topic, ChatMessageModel streamingMessage, string startMessageId);
}
```

3. CREATE `WebChat.Client/Services/Streaming/StreamingService.cs`:
   - Implements IStreamingService
   - Dependencies: IChatMessagingService, IDispatcher, ITopicService
   - Streaming logic dispatches actions to stores (StreamChunk, StreamCompleted, AddMessage)
   - No render callback needed - components subscribe to stores directly

Key differences from StreamingCoordinator:
- Uses IDispatcher.Dispatch(new StreamChunk(...)) instead of stateManager.UpdateStreamingMessage()
- Uses IDispatcher.Dispatch(new AddMessage(...)) instead of messages.Add()
- Uses IDispatcher.Dispatch(new StreamCompleted(...)) instead of stateManager.StopStreaming()
- Uses IDispatcher.Dispatch(new ShowApproval(...)) instead of stateManager.SetApprovalRequest()
- Throttling handled by RenderCoordinator in components, not here
  </action>
  <verify>
    `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds (StreamingCoordinator still exists at this point)
  </verify>
  <done>
    - BufferRebuildUtility.cs created with extracted pure functions
    - IStreamingService.cs created
    - StreamingService.cs created implementing IStreamingService
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete StreamingCoordinator and migrate consumers</name>
  <files>
    WebChat.Client/Services/Streaming/StreamingCoordinator.cs
    WebChat.Client/Contracts/IStreamingCoordinator.cs
    WebChat.Client/Program.cs
    WebChat.Client/State/Effects/SendMessageEffect.cs
    WebChat.Client/Services/Streaming/StreamResumeService.cs
  </files>
  <action>
1. DELETE `WebChat.Client/Services/Streaming/StreamingCoordinator.cs`
2. DELETE `WebChat.Client/Contracts/IStreamingCoordinator.cs`

3. UPDATE `WebChat.Client/Program.cs`:
   - Remove: `builder.Services.AddScoped<IStreamingCoordinator, StreamingCoordinator>();`
   - Add: `builder.Services.AddScoped<IStreamingService, StreamingService>();`

4. UPDATE `WebChat.Client/State/Effects/SendMessageEffect.cs`:
   - Replace IStreamingCoordinator with IStreamingService
   - Change: `_streamingCoordinator.StreamResponseAsync(topic, action.Message, () => Task.CompletedTask)`
   - To: `_streamingService.StreamResponseAsync(topic, action.Message)`

5. UPDATE `WebChat.Client/Services/Streaming/StreamResumeService.cs`:
   - Remove IStreamingCoordinator dependency
   - Add IStreamingService dependency
   - Replace `streamingCoordinator.RebuildFromBuffer(...)` with `BufferRebuildUtility.RebuildFromBuffer(...)`
   - Replace `streamingCoordinator.StripKnownContent(...)` with `BufferRebuildUtility.StripKnownContent(...)`
   - Replace `streamingCoordinator.ResumeStreamResponseAsync(...)` with `_streamingService.ResumeStreamResponseAsync(...)`
   - Remove the render callback pattern (no longer needed)

6. Build to verify compilation succeeds.
  </action>
  <verify>
    `dotnet build WebChat.Client/WebChat.Client.csproj` succeeds with no errors
  </verify>
  <done>
    - StreamingCoordinator.cs deleted
    - IStreamingCoordinator.cs deleted
    - SendMessageEffect uses IStreamingService
    - StreamResumeService uses IStreamingService and BufferRebuildUtility
    - Program.cs registers IStreamingService
    - Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate StreamingCoordinator tests</name>
  <files>
    Tests/Unit/WebChat/Client/StreamingCoordinatorTests.cs
    Tests/Integration/WebChat/Client/StreamingCoordinatorIntegrationTests.cs
    Tests/Unit/WebChat/Client/BufferRebuildUtilityTests.cs
  </files>
  <action>
1. RENAME and UPDATE `Tests/Unit/WebChat/Client/StreamingCoordinatorTests.cs` to `Tests/Unit/WebChat/Client/BufferRebuildUtilityTests.cs`:
   - Keep all RebuildFromBuffer tests (they test pure functions)
   - Keep all StripKnownContent tests
   - Change class name to BufferRebuildUtilityTests
   - Remove test setup that created StreamingCoordinator
   - Call static methods directly: `BufferRebuildUtility.RebuildFromBuffer(...)`
   - DELETE streaming tests (StreamResponseAsync, ResumeStreamResponseAsync, ThrottledRender) - behavior tested via integration tests

2. UPDATE `Tests/Integration/WebChat/Client/StreamingCoordinatorIntegrationTests.cs`:
   - Rename to StreamingServiceIntegrationTests.cs
   - Replace StreamingCoordinator with StreamingService
   - Remove ChatStateManager, use stores instead
   - Verify actions dispatched during streaming

3. Run all WebChat.Client tests to verify.
  </action>
  <verify>
    `dotnet test Tests/Tests.csproj --filter "FullyQualifiedName~WebChat.Client"` all pass
  </verify>
  <done>
    - BufferRebuildUtilityTests.cs exists with pure function tests
    - StreamingServiceIntegrationTests.cs exists
    - All tests pass
    - No references to StreamingCoordinator in test code
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build Agent.sln`
2. Run all tests: `dotnet test Tests/Tests.csproj`
3. Grep confirms no StreamingCoordinator references: `grep -r "StreamingCoordinator\|IStreamingCoordinator" --include="*.cs" WebChat.Client/`
4. Grep confirms no references in tests: `grep -r "StreamingCoordinator" --include="*.cs" Tests/`
</verification>

<success_criteria>
1. StreamingCoordinator.cs and IStreamingCoordinator.cs deleted from codebase
2. BufferRebuildUtility.cs contains extracted pure functions
3. StreamingService.cs implements IStreamingService with store-based dispatching
4. No compilation errors in WebChat.Client project
5. All tests pass
6. SendMessageEffect and StreamResumeService use new abstractions
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-02-SUMMARY.md`
</output>
