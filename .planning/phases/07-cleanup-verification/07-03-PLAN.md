---
phase: 07-cleanup-verification
plan: 03
type: execute
wave: 3
depends_on: [07-02]
files_modified:
  - WebChat.Client/**/*.cs
  - Tests/**/*.cs
autonomous: false

must_haves:
  truths:
    - "No dead code remains in WebChat.Client project"
    - "All WebChat functionality works: messaging, streaming, topics, reconnection, tool approval"
    - "Test coverage is same or better than before refactoring"
    - "No unused using statements or orphaned types"
  artifacts:
    - path: "WebChat.Client/**/*.cs"
      provides: "Clean codebase without legacy references"
      not_contains: "ChatStateManager|StreamingCoordinator"
  key_links:
    - from: "All components"
      to: "Stores"
      via: "IDispatcher"
      pattern: "IDispatcher|Store"
---

<objective>
Sweep for dead code, run full test suite, and verify all WebChat functionality manually.

Purpose: Final cleanup ensures no orphaned code remains and all functionality works correctly after the refactoring.

Output: Clean codebase with passing tests and verified functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-verification/07-RESEARCH.md
@.planning/phases/07-cleanup-verification/07-01-SUMMARY.md
@.planning/phases/07-cleanup-verification/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dead code sweep</name>
  <files>
    WebChat.Client/**/*.cs
  </files>
  <action>
1. Search for orphaned references to deleted types:
   ```bash
   grep -r "ChatStateManager\|IChatStateManager\|StreamingCoordinator\|IStreamingCoordinator" --include="*.cs"
   ```
   If any found, fix or remove.

2. Search for unused using statements in WebChat.Client:
   - Build with warnings enabled
   - IDE warning CS8019 indicates unused usings
   - Remove any unused `using WebChat.Client.Services.State;` or similar

3. Check for orphaned test fixtures or helpers that only served deleted code:
   - Review Tests/Unit/WebChat/Fixtures/ for unused fakes
   - Remove any fakes that are no longer referenced

4. Check for unused private members:
   - IDE warning CS0169 (unused field)
   - IDE warning CS0414 (unused assignment)
   - Remove any orphaned private fields or methods

5. Build with TreatWarningsAsErrors to catch issues:
   ```bash
   dotnet build WebChat.Client/WebChat.Client.csproj -warnaserror
   ```

6. Fix any warnings found.
  </action>
  <verify>
    `dotnet build WebChat.Client/WebChat.Client.csproj -warnaserror` succeeds with no warnings
  </verify>
  <done>
    - No references to deleted types remain
    - No unused using statements
    - No unused private members
    - Clean build with warnings-as-errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Full test suite verification</name>
  <files>
    Tests/**/*.cs
  </files>
  <action>
1. Run the complete test suite:
   ```bash
   dotnet test Tests/Tests.csproj --logger "console;verbosity=detailed"
   ```

2. If any tests fail:
   - Identify root cause (likely missing migration from Plans 01/02)
   - Fix the test or the production code as appropriate
   - Re-run until all pass

3. Verify test count is reasonable:
   - ChatStateManagerTests was deleted (~69 tests)
   - Store tests exist to cover equivalent behavior
   - Net test count may decrease slightly but coverage should be equivalent

4. Check for flaky tests by running twice:
   ```bash
   dotnet test Tests/Tests.csproj --filter "FullyQualifiedName~WebChat"
   dotnet test Tests/Tests.csproj --filter "FullyQualifiedName~WebChat"
   ```

5. If flaky tests found, fix or document.
  </action>
  <verify>
    `dotnet test Tests/Tests.csproj` all tests pass consistently (run twice)
  </verify>
  <done>
    - All tests pass
    - No flaky tests
    - Test suite runs consistently
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete WebChat refactoring: deleted ChatStateManager (272 lines) and StreamingCoordinator (417 lines), migrated all code to use store-based unidirectional data flow.
  </what-built>
  <how-to-verify>
    1. Start the application:
       ```bash
       cd DockerCompose && docker compose up -d
       ```
       Or run locally if preferred.

    2. Open WebChat in browser (typically http://localhost:5000 or configured port)

    3. Test messaging flow:
       - Select an agent
       - Create a new topic by sending a message
       - Verify message appears in chat
       - Verify assistant response streams in real-time
       - Verify streaming cursor/indicator visible during streaming

    4. Test topic management:
       - Create multiple topics
       - Switch between topics
       - Verify messages persist per topic
       - Delete a topic, verify it disappears

    5. Test reconnection (simulate network issue):
       - Start a streaming response
       - Disconnect network briefly (or stop/start SignalR connection)
       - Verify stream resumes after reconnection
       - Verify no duplicate content

    6. Test tool approval flow:
       - Trigger a tool that requires approval (depends on agent config)
       - Verify approval modal appears
       - Approve or reject
       - Verify flow continues correctly

    7. Check browser console for errors:
       - Open DevTools (F12)
       - Check Console tab for JavaScript errors
       - Check Network tab for failed requests

    8. Performance check:
       - During streaming, verify UI remains responsive
       - Sidebar should not flicker during streaming
       - No visible lag or freezing
  </how-to-verify>
  <resume-signal>
    Type "verified" if all functionality works correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. Full solution builds: `dotnet build Agent.sln`
2. All tests pass: `dotnet test Tests/Tests.csproj`
3. No dead code: `grep -r "ChatStateManager\|StreamingCoordinator" --include="*.cs"` returns empty
4. Manual verification complete (human confirmed)
</verification>

<success_criteria>
1. No dead code in WebChat.Client project
2. All tests pass consistently
3. All WebChat functionality verified manually:
   - Messaging works
   - Streaming works with visual feedback
   - Topic management works
   - Reconnection/resume works
   - Tool approval works
4. No console errors in browser
5. Performance acceptable (no UI freezes during streaming)
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-03-SUMMARY.md`
</output>
