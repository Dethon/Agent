---
phase: 05-component-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - WebChat.Client/Components/ApprovalModal.razor
  - WebChat.Client/State/Approval/ApprovalActions.cs
autonomous: true

must_haves:
  truths:
    - "ApprovalModal subscribes to ApprovalStore for current request"
    - "ApprovalModal dispatches actions for approve/reject"
    - "Modal shows/hides based on store state"
  artifacts:
    - path: "WebChat.Client/Components/ApprovalModal.razor"
      provides: "Approval modal with store subscription"
      contains: "@inherits StoreSubscriberComponent"
    - path: "WebChat.Client/State/Approval/ApprovalActions.cs"
      provides: "Approval response action"
      contains: "RespondToApproval"
  key_links:
    - from: "ApprovalModal.razor"
      to: "ApprovalStore"
      via: "Subscribe in OnInitialized"
      pattern: "Subscribe.*ApprovalStore"
    - from: "ApprovalModal.razor"
      to: "IDispatcher"
      via: "dispatch response action"
      pattern: "Dispatcher.Dispatch.*RespondToApproval"
---

<objective>
Migrate ApprovalModal to store-based pattern with action dispatch.

Purpose: ApprovalModal is a self-contained component that shows tool approval requests. It should subscribe to ApprovalStore for the current request and dispatch actions when the user responds.

Output: ApprovalModal migrated to use stores, with new approval response action.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-component-architecture/05-CONTEXT.md
@.planning/phases/05-component-architecture/05-RESEARCH.md
@WebChat.Client/State/StoreSubscriberComponent.cs
@WebChat.Client/State/Approval/ApprovalStore.cs
@WebChat.Client/State/Approval/ApprovalActions.cs
@WebChat.Client/Contracts/IApprovalService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add approval response action</name>
  <files>
    WebChat.Client/State/Approval/ApprovalActions.cs
  </files>
  <action>
Add new action to ApprovalActions.cs:
```csharp
/// <summary>
/// User responded to an approval request.
/// </summary>
public record RespondToApproval(string ApprovalId, ToolApprovalResult Result) : IAction;
```

Note: ToolApprovalResult is from Domain.DTOs namespace.

Add using statement if needed: `using Domain.DTOs;`
  </action>
  <verify>
Build succeeds: `dotnet build WebChat.Client`
ApprovalActions.cs contains `public record RespondToApproval`
  </verify>
  <done>RespondToApproval action exists for approval responses</done>
</task>

<task type="auto">
  <name>Task 2: Migrate ApprovalModal to store subscription</name>
  <files>
    WebChat.Client/Components/ApprovalModal.razor
  </files>
  <action>
Refactor ApprovalModal.razor:
1. Add `@inherits StoreSubscriberComponent`
2. Inject `ApprovalStore` and `IDispatcher`
3. Keep `IApprovalService` injection (still needed for the actual HTTP call)
4. Remove `[Parameter]` for ApprovalRequest and OnResponded
5. Add private field `_approvalRequest` of type `ToolApprovalRequestMessage?`
6. Override `OnInitialized()`:
   - Subscribe to `ApprovalStore.StateObservable` for `CurrentRequest`
   - Set `_approvalRequest` from subscription
7. Update `RespondAsync()` method:
   - After successful `ApprovalService.RespondToApprovalAsync()` call
   - Dispatch `new ClearApproval()` instead of `OnResponded.InvokeAsync()`
   - The ClearApproval action already exists in ApprovalActions.cs
8. Update markup to use `_approvalRequest` instead of `ApprovalRequest`

Keep the existing:
- `_isResponding` flag for button disable state
- `FormatToolName` and `FormatValue` helper methods
- All the modal markup and styling

The component should remain under 120 lines.
  </action>
  <verify>
Build succeeds: `dotnet build WebChat.Client`
ApprovalModal.razor contains `@inherits StoreSubscriberComponent`
ApprovalModal.razor contains `@inject ApprovalStore`
ApprovalModal.razor contains `@inject IDispatcher`
ApprovalModal.razor contains `Dispatcher.Dispatch(new ClearApproval`
ApprovalModal.razor does NOT contain `[Parameter]`
  </verify>
  <done>ApprovalModal subscribes to ApprovalStore and dispatches ClearApproval on response</done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build WebChat.Client` compiles without errors
2. ApprovalModal.razor:
   - Inherits StoreSubscriberComponent
   - Subscribes to ApprovalStore
   - Dispatches ClearApproval after response
   - No parameters
   - Under 120 lines
3. ApprovalActions.cs contains RespondToApproval action
</verification>

<success_criteria>
- ApprovalModal displays approval request from ApprovalStore (not parameter)
- ApprovalModal dispatches ClearApproval after successful response
- Component inherits StoreSubscriberComponent
- RespondToApproval action exists for future Effect usage
</success_criteria>

<output>
After completion, create `.planning/phases/05-component-architecture/05-02-SUMMARY.md`
</output>
