---
phase: 05-component-architecture
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - WebChat.Client/Components/TopicList.razor
  - WebChat.Client/State/Topics/TopicsActions.cs
autonomous: true

must_haves:
  truths:
    - "TopicList subscribes to TopicsStore for topics, selection, and agents"
    - "TopicList subscribes to StreamingStore for streaming indicators"
    - "TopicList dispatches SelectTopic, RemoveTopic, SelectAgent actions"
    - "Component stays under 100 lines in code block"
  artifacts:
    - path: "WebChat.Client/Components/TopicList.razor"
      provides: "Topic sidebar with store subscriptions"
      contains: "@inherits StoreSubscriberComponent"
    - path: "WebChat.Client/State/Topics/TopicsActions.cs"
      provides: "Topic actions for UI operations"
      contains: "CreateNewTopic"
  key_links:
    - from: "TopicList.razor"
      to: "TopicsStore"
      via: "Subscribe in OnInitialized"
      pattern: "Subscribe.*TopicsStore"
    - from: "TopicList.razor"
      to: "StreamingStore"
      via: "Subscribe for streaming topics"
      pattern: "Subscribe.*StreamingStore"
---

<objective>
Migrate TopicList to store-based pattern with multiple subscriptions.

Purpose: TopicList is the largest existing component (212 lines). It needs multiple store subscriptions (topics, selection, agents, streaming) and demonstrates the pattern for complex components with multiple data sources.

Output: TopicList migrated to use stores with proper subscription management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-component-architecture/05-CONTEXT.md
@.planning/phases/05-component-architecture/05-RESEARCH.md
@WebChat.Client/State/StoreSubscriberComponent.cs
@WebChat.Client/State/Topics/TopicsStore.cs
@WebChat.Client/State/Topics/TopicsActions.cs
@WebChat.Client/State/Streaming/StreamingStore.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CreateNewTopic action</name>
  <files>
    WebChat.Client/State/Topics/TopicsActions.cs
  </files>
  <action>
Add new action to TopicsActions.cs:
```csharp
/// <summary>
/// Create a new topic (deselect current topic for new conversation).
/// </summary>
public record CreateNewTopic : IAction;
```

This action will be used by TopicList when user clicks "New Chat" button.
  </action>
  <verify>
Build succeeds: `dotnet build WebChat.Client`
TopicsActions.cs contains `public record CreateNewTopic`
  </verify>
  <done>CreateNewTopic action exists for new conversation flow</done>
</task>

<task type="auto">
  <name>Task 2: Migrate TopicList to store subscriptions</name>
  <files>
    WebChat.Client/Components/TopicList.razor
  </files>
  <action>
Refactor TopicList.razor:

1. Add directives at top:
```razor
@inherits StoreSubscriberComponent
@inject TopicsStore TopicsStore
@inject StreamingStore StreamingStore
@inject IDispatcher Dispatcher
```

2. Remove ALL `[Parameter]` properties:
   - Topics, SelectedTopic, Agents, SelectedAgentId
   - OnTopicSelected, OnTopicDeleted, OnNewTopic, OnAgentChanged
   - IsStreaming, UnreadCounts, StreamingTopics

3. Add private fields:
```csharp
private IReadOnlyList<StoredTopic> _topics = [];
private string? _selectedTopicId;
private IReadOnlyList<AgentInfo> _agents = [];
private string? _selectedAgentId;
private IReadOnlySet<string> _streamingTopics = new HashSet<string>();
private IReadOnlyDictionary<string, int> _unreadCounts = new Dictionary<string, int>();
```

4. Override `OnInitialized()` with subscriptions:
```csharp
protected override void OnInitialized()
{
    Subscribe(TopicsStore.StateObservable,
        state => state.Topics,
        topics => _topics = topics);
    Subscribe(TopicsStore.StateObservable,
        state => state.SelectedTopicId,
        id => _selectedTopicId = id);
    Subscribe(TopicsStore.StateObservable,
        state => state.Agents,
        agents => _agents = agents);
    Subscribe(TopicsStore.StateObservable,
        state => state.SelectedAgentId,
        id => _selectedAgentId = id);
    Subscribe(StreamingStore.StateObservable,
        state => state.ActiveStreams.Keys.ToHashSet(),
        ids => _streamingTopics = ids);
    // UnreadCounts will be computed from topics state
}
```

5. Update event handlers to dispatch actions:
```csharp
private void HandleTopicClick(StoredTopic topic)
{
    if (_selectedTopicId != topic.TopicId)
    {
        Dispatcher.Dispatch(new SelectTopic(topic.TopicId));
    }
}

private void HandleNewTopic()
{
    Dispatcher.Dispatch(new CreateNewTopic());
}

private void ConfirmDelete(StoredTopic topic)
{
    _deleteConfirmTopicId = null;
    Dispatcher.Dispatch(new RemoveTopic(topic.TopicId));
}

private void SelectAgent(string agentId)
{
    _dropdownOpen = false;
    if (agentId != _selectedAgentId)
    {
        Dispatcher.Dispatch(new SelectAgent(agentId));
    }
}
```

6. Update computed properties:
```csharp
private string SelectedAgentName => _agents.FirstOrDefault(a => a.Id == _selectedAgentId)?.Name ?? "Select Agent";

private int GetUnreadCount(string topicId)
{
    return _unreadCounts.GetValueOrDefault(topicId);
}

private bool IsTopicStreaming(string topicId)
{
    return _streamingTopics.Contains(topicId);
}
```

7. Update markup references:
   - `SelectedTopic?.TopicId` -> `_selectedTopicId`
   - `Topics` -> `_topics`
   - `Agents` -> `_agents`
   - `SelectedAgentId` -> `_selectedAgentId`

Keep existing:
- Delete confirmation logic (_deleteConfirmTopicId)
- Dropdown logic (_dropdownOpen)
- All markup and styling
  </action>
  <verify>
Build succeeds: `dotnet build WebChat.Client`
TopicList.razor contains `@inherits StoreSubscriberComponent`
TopicList.razor contains `@inject TopicsStore`
TopicList.razor contains `@inject StreamingStore`
TopicList.razor contains `@inject IDispatcher`
TopicList.razor contains `Dispatcher.Dispatch(new SelectTopic`
TopicList.razor contains `Dispatcher.Dispatch(new RemoveTopic`
TopicList.razor contains `Dispatcher.Dispatch(new SelectAgent`
TopicList.razor does NOT contain `[Parameter]`
  </verify>
  <done>TopicList subscribes to stores and dispatches actions for all interactions</done>
</task>

<task type="auto">
  <name>Task 3: Add unread counts subscription</name>
  <files>
    WebChat.Client/Components/TopicList.razor
    WebChat.Client/State/Messages/MessagesSelectors.cs
  </files>
  <action>
Update TopicList to compute unread counts from MessagesStore:

1. Inject MessagesStore:
```razor
@inject MessagesStore MessagesStore
```

2. Add unread counts subscription in OnInitialized():
```csharp
// For unread counts, combine topics with messages state
// This requires reading both stores
Subscribe(MessagesStore.StateObservable,
    state => ComputeUnreadCounts(state, TopicsStore.State),
    counts => _unreadCounts = counts);
```

3. Add helper method:
```csharp
private static IReadOnlyDictionary<string, int> ComputeUnreadCounts(
    MessagesState messagesState,
    TopicsState topicsState)
{
    var result = new Dictionary<string, int>();
    foreach (var topic in topicsState.Topics)
    {
        if (topic.TopicId == topicsState.SelectedTopicId) continue;

        var messages = messagesState.MessagesByTopic.GetValueOrDefault(topic.TopicId, []);
        var assistantCount = messages.Count(m => m.Role != "user");
        var lastRead = topic.LastReadMessageCount;

        if (assistantCount > lastRead)
        {
            result[topic.TopicId] = assistantCount - lastRead;
        }
    }
    return result;
}
```

Note: The unread count computation is simplified compared to ChatStateManager. The full logic with streaming message consideration can be refined if needed.
  </action>
  <verify>
Build succeeds: `dotnet build WebChat.Client`
TopicList.razor contains `@inject MessagesStore`
TopicList.razor contains `ComputeUnreadCounts`
  </verify>
  <done>TopicList computes unread counts from MessagesStore and TopicsStore</done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build WebChat.Client` compiles without errors
2. TopicList.razor:
   - Inherits StoreSubscriberComponent
   - Subscribes to TopicsStore, StreamingStore, MessagesStore
   - Dispatches SelectTopic, RemoveTopic, SelectAgent, CreateNewTopic
   - No parameters
   - Code block under 100 lines (markup can exceed)
3. TopicsActions.cs contains CreateNewTopic action
</verification>

<success_criteria>
- TopicList displays topics from TopicsStore (not parameters)
- TopicList displays streaming indicators from StreamingStore
- TopicList computes unread counts from MessagesStore
- All user interactions dispatch actions
- Component inherits StoreSubscriberComponent
</success_criteria>

<output>
After completion, create `.planning/phases/05-component-architecture/05-03-SUMMARY.md`
</output>
