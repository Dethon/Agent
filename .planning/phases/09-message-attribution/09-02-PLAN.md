---
phase: 09-message-attribution
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - WebChat.Client/Components/ChatMessage.razor
  - WebChat.Client/Components/Chat/MessageList.razor
  - WebChat.Client/wwwroot/css/app.css
autonomous: true

must_haves:
  truths:
    - "User messages show avatar to the left of the message bubble"
    - "Agent messages have no avatar column (full-width)"
    - "Username appears on hover over message bubble"
    - "Own messages have different background color than others"
    - "Avatar shows only on first message in consecutive group from same sender"
  artifacts:
    - path: "WebChat.Client/Components/ChatMessage.razor"
      provides: "Message rendering with avatar column and sender attribution"
      contains: "AvatarImage"
    - path: "WebChat.Client/Components/Chat/MessageList.razor"
      provides: "Message grouping logic and current user context"
      contains: "ShouldShowAvatar"
    - path: "WebChat.Client/wwwroot/css/app.css"
      provides: "Message wrapper, avatar column, and own message styling"
      contains: "message-wrapper"
  key_links:
    - from: "WebChat.Client/Components/ChatMessage.razor"
      to: "WebChat.Client/Components/AvatarImage.razor"
      via: "component reference"
      pattern: "<AvatarImage"
    - from: "WebChat.Client/Components/Chat/MessageList.razor"
      to: "WebChat.Client/State/UserIdentity/UserIdentityStore.cs"
      via: "store subscription"
      pattern: "UserIdentityStore"
---

<objective>
Update ChatMessage and MessageList components to display sender avatars, usernames on hover, and distinguish own messages visually.

Purpose: Complete message attribution UI - users see who sent each message and can identify their own messages.
Output: Messages display avatars (grouped), hover tooltips for usernames, own messages styled differently.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-message-attribution/09-CONTEXT.md
@.planning/phases/09-message-attribution/09-RESEARCH.md
@.planning/phases/09-message-attribution/09-01-SUMMARY.md

# Existing files to reference
@WebChat.Client/Components/ChatMessage.razor
@WebChat.Client/Components/Chat/MessageList.razor
@WebChat.Client/Components/AvatarImage.razor
@WebChat.Client/wwwroot/css/app.css
@WebChat.Client/State/UserIdentity/UserIdentityStore.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ChatMessage with avatar column and own message styling</name>
  <files>WebChat.Client/Components/ChatMessage.razor</files>
  <action>
Add new parameters:
- `bool ShowAvatar` - whether to show avatar (vs placeholder space)
- `bool IsOwnMessage` - whether this message is from current user
- `string? CurrentUserId` - current user's ID for comparison (optional, IsOwnMessage is primary)

Update component structure to wrap message in a flex container:
```razor
<div class="@GetMessageWrapperClass()">
    @if (Message.Role != "assistant")
    {
        <div class="message-avatar-column">
            @if (ShowAvatar)
            {
                <AvatarImage Username="@Message.SenderUsername"
                             AvatarUrl="@Message.SenderAvatarUrl"
                             Size="28" />
            }
            else
            {
                <div class="avatar-placeholder-space"></div>
            }
        </div>
    }

    <div class="@GetMessageClass()" title="@GetTooltipText()">
        @* Existing message content (reasoning, tool calls, content, typing indicator) *@
    </div>
</div>
```

Add helper methods:
- `GetMessageWrapperClass()` - returns "message-wrapper" plus "agent" for assistant role
- Update existing `GetMessageClass()` - add "own" class when IsOwnMessage is true
- `GetTooltipText()` - returns Message.SenderUsername for user messages, null/empty for assistant

Keep all existing message rendering logic (collapsible blocks, markdown, typing indicator).
Avatar size 28px for compact display (within 24-32px range per CONTEXT.md).
Agent messages skip avatar column entirely (no wrapper div for avatar).
  </action>
  <verify>
Build passes: `dotnet build WebChat.Client`
Component compiles with new parameters.
No breaking changes - existing code that doesn't pass new parameters gets default values.
  </verify>
  <done>
ChatMessage renders avatar column for user messages with proper grouping support.
Own messages get "own" CSS class for different styling.
Username tooltip appears on hover over message bubble.
Agent messages render without avatar column (existing full-width behavior).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MessageList with user context and message grouping</name>
  <files>WebChat.Client/Components/Chat/MessageList.razor</files>
  <action>
Add UserIdentityStore injection and subscription:
- `@inject UserIdentityStore UserIdentityStore`
- Private field `_currentUserId` (string?)
- Subscribe to UserIdentityStore.StateObservable for SelectedUserId changes

Add message grouping logic:
```csharp
private bool ShouldShowAvatar(int index)
{
    if (index == 0) return true;

    var current = _messages[index];
    var previous = _messages[index - 1];

    // Show avatar if sender OR role changed
    return current.SenderId != previous.SenderId
        || current.Role != previous.Role;
}

private bool IsOwnMessage(ChatMessageModel message)
{
    return message.Role == "user"
        && !string.IsNullOrEmpty(message.SenderId)
        && message.SenderId == _currentUserId;
}
```

Update message rendering loop:
```razor
@foreach (var (message, index) in _messages.Select((m, i) => (m, i)))
{
    <ChatMessage Message="@message"
                 ShowAvatar="@ShouldShowAvatar(index)"
                 IsOwnMessage="@IsOwnMessage(message)" />
}
```

Add using statement for LINQ `.Select((m, i) => (m, i))` pattern if not present.
Keep all existing subscriptions (TopicsStore, MessagesStore, StreamingStore).
Keep existing empty state, suggestion chips, and streaming message display.
  </action>
  <verify>
Build passes: `dotnet build WebChat.Client`
MessageList subscribes to UserIdentityStore without errors.
Message grouping logic compiles correctly.
  </verify>
  <done>
MessageList passes ShowAvatar and IsOwnMessage to ChatMessage components.
Avatar displays only on first message in consecutive group from same sender.
Current user's messages identified for own message styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS styles for message wrapper, avatar column, and own messages</name>
  <files>WebChat.Client/wwwroot/css/app.css</files>
  <action>
Add new CSS rules after the existing "Chat Messages" section:

```css
/* ===================================
   Message Attribution Layout
   =================================== */

.message-wrapper {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
}

.message-wrapper.agent {
    display: block; /* Agent messages don't need flex layout */
}

.message-avatar-column {
    flex-shrink: 0;
    width: 28px;
    padding-top: 0.25rem; /* Align avatar with message bubble top */
}

.avatar-placeholder-space {
    width: 28px;
    height: 28px;
}

/* Avatar image component styles */
.avatar-image-container {
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.avatar-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

.avatar-fallback {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    user-select: none;
}

/* Own message styling - different background color */
.chat-message.user.own {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

[data-theme="dark"] .chat-message.user.own {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
}
```

Update existing `.chat-message` rule:
- In `.message-wrapper`, the `.chat-message` should have `flex: 1` and `max-width: 75%`
- Agent messages (when wrapper has `.agent` class) should retain full width

Add responsive adjustments in existing media queries if needed for avatar column on small screens.
  </action>
  <verify>
CSS is valid (no syntax errors).
Build passes: `dotnet build WebChat.Client`
Run app and verify visually (checkpoint in UAT).
  </verify>
  <done>
Message wrapper uses flexbox for avatar + bubble layout.
Avatar column has fixed width matching AvatarImage Size parameter.
Own messages have distinct green gradient background.
Agent messages render full-width without avatar column.
Placeholder space maintains alignment for grouped messages.
  </done>
</task>

</tasks>

<verification>
- `dotnet build WebChat.Client` succeeds
- ChatMessage accepts ShowAvatar and IsOwnMessage parameters
- MessageList subscribes to UserIdentityStore and computes message grouping
- CSS provides proper layout for avatar column and own message distinction
- App runs without console errors
</verification>

<success_criteria>
- MSG-01: Messages display sender's username (on hover tooltip)
- MSG-02: Messages display sender's avatar (28px circular, left of bubble)
- MSG-03: User's own messages visually distinguished (green gradient vs purple)
- Avatar grouping: first message in consecutive group shows avatar, others show placeholder
- Agent messages: full-width, no avatar column, no hover username
</success_criteria>

<output>
After completion, create `.planning/phases/09-message-attribution/09-02-SUMMARY.md`
</output>
