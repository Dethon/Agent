---
phase: 09-message-attribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - WebChat.Client/Models/ChatMessageModel.cs
  - WebChat.Client/Helpers/AvatarHelper.cs
  - WebChat.Client/Components/AvatarImage.razor
autonomous: true

must_haves:
  truths:
    - "Messages have sender identity fields available"
    - "Avatar can display image or fallback initials"
    - "Fallback colors are deterministic per username"
  artifacts:
    - path: "WebChat.Client/Models/ChatMessageModel.cs"
      provides: "Sender identity properties"
      contains: "SenderId"
    - path: "WebChat.Client/Helpers/AvatarHelper.cs"
      provides: "Deterministic color hashing and initials extraction"
      exports: ["GetColorForUsername", "GetInitials"]
    - path: "WebChat.Client/Components/AvatarImage.razor"
      provides: "Reusable avatar component with image and fallback"
      min_lines: 20
  key_links:
    - from: "WebChat.Client/Components/AvatarImage.razor"
      to: "WebChat.Client/Helpers/AvatarHelper.cs"
      via: "static method calls"
      pattern: "AvatarHelper\\.Get"
---

<objective>
Extend ChatMessageModel with sender identity fields and create reusable AvatarImage component with fallback display.

Purpose: Foundation for message attribution - messages need sender data and a component to render avatars consistently.
Output: ChatMessageModel with SenderId/SenderUsername/SenderAvatarUrl, AvatarHelper for deterministic colors, AvatarImage component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-message-attribution/09-CONTEXT.md
@.planning/phases/09-message-attribution/09-RESEARCH.md
@.planning/phases/08-user-identity/08-01-SUMMARY.md

# Existing files to reference
@WebChat.Client/Models/ChatMessageModel.cs
@WebChat.Client/Models/UserConfig.cs
@WebChat.Client/Components/UserIdentityPicker.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ChatMessageModel with sender identity fields</name>
  <files>WebChat.Client/Models/ChatMessageModel.cs</files>
  <action>
Add three nullable properties to the existing ChatMessageModel record:
- `string? SenderId` - User ID (null for agent messages)
- `string? SenderUsername` - Display name (null for agent messages)
- `string? SenderAvatarUrl` - Avatar URL (null for agent messages)

Keep all existing properties (Role, Content, Reasoning, ToolCalls, IsError, HasContent).
These are init-only properties matching the existing record pattern.
Agent messages will have null sender fields - their Role="assistant" distinguishes them.
  </action>
  <verify>
Build passes: `dotnet build WebChat.Client`
No breaking changes to existing code (properties are nullable with no required initializer).
  </verify>
  <done>
ChatMessageModel has SenderId, SenderUsername, and SenderAvatarUrl properties.
Existing code continues to work since new properties are optional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AvatarHelper and AvatarImage component</name>
  <files>WebChat.Client/Helpers/AvatarHelper.cs, WebChat.Client/Components/AvatarImage.razor</files>
  <action>
**AvatarHelper.cs** - Create new file in `WebChat.Client/Helpers/` directory:
- Static class with two public methods:
- `GetColorForUsername(string? username)` - Returns hex color string from predefined palette based on username hash. Use simple deterministic hash: `foreach char, hash = (hash * 31 + c) & 0x7FFFFFFF`. Return `Colors[hash % Colors.Length]`.
- `GetInitials(string? username)` - Returns initials: first char uppercase for single word, first char of first two words for multi-word. Return "?" for null/empty.
- Color palette: 8 distinct colors like `#FF6B6B`, `#4ECDC4`, `#45B7D1`, `#FFA07A`, `#98D8C8`, `#F7DC6F`, `#BB8FCE`, `#85C1E2`.

**AvatarImage.razor** - Create new component in `WebChat.Client/Components/`:
- Parameters: `string? Username`, `string? AvatarUrl`, `int Size = 32`
- Private field `_imageLoadFailed` (bool) to track image load failure
- Render logic:
  - If AvatarUrl is set and image hasn't failed: `<img>` with onerror handler to set `_imageLoadFailed = true`
  - Otherwise: colored circle with initials using AvatarHelper methods
- CSS classes: `avatar-image-container`, `avatar-image`, `avatar-fallback`
- Inline style for dynamic size and background color
- Circular shape (border-radius: 50%)

Use file-scoped namespace. Follow existing component patterns from UserIdentityPicker.razor.
  </action>
  <verify>
Build passes: `dotnet build WebChat.Client`
AvatarHelper.GetColorForUsername("Alice") returns consistent color on multiple calls.
AvatarHelper.GetInitials("Alice Bob") returns "AB".
AvatarHelper.GetInitials("Charlie") returns "C".
AvatarHelper.GetInitials(null) returns "?".
  </verify>
  <done>
AvatarHelper provides deterministic color generation and initials extraction.
AvatarImage component renders avatar image with fallback to colored initials circle.
Same username always produces same fallback color.
  </done>
</task>

</tasks>

<verification>
- `dotnet build WebChat.Client` succeeds with no errors
- ChatMessageModel retains existing functionality (HasContent property works)
- New sender properties are accessible and nullable
- AvatarHelper methods produce consistent, deterministic results
</verification>

<success_criteria>
- ChatMessageModel extended with SenderId, SenderUsername, SenderAvatarUrl
- AvatarHelper provides GetColorForUsername and GetInitials static methods
- AvatarImage component renders image or fallback based on AvatarUrl presence
- Build succeeds, no breaking changes to existing code
</success_criteria>

<output>
After completion, create `.planning/phases/09-message-attribution/09-01-SUMMARY.md`
</output>
